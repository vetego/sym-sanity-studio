{"version":3,"file":"generateAction.js","sources":["../../src/actions/typegen/generate.telemetry.ts","../../src/actions/typegen/generateAction.ts"],"sourcesContent":["import {defineTrace} from '@sanity/telemetry'\n\ninterface TypesGeneratedTraceAttributes {\n  outputSize: number\n  queriesCount: number\n  schemaTypesCount: number\n  queryFilesCount: number\n  filesWithErrors: number\n  typeNodesGenerated: number\n  unknownTypeNodesGenerated: number\n  unknownTypeNodesRatio: number\n  emptyUnionTypeNodesGenerated: number\n  configOverloadClientMethods: boolean\n  configMethod: 'legacy' | 'cli'\n}\n\nexport const TypesGeneratedTrace = defineTrace<TypesGeneratedTraceAttributes>({\n  name: 'Types Generated',\n  version: 0,\n  description: 'Trace emitted when generating TypeScript types for queries',\n})\n","/* eslint-disable max-statements */\nimport {mkdir, stat, writeFile} from 'node:fs/promises'\nimport {dirname, isAbsolute, join} from 'node:path'\nimport {env} from 'node:process'\nimport {Worker} from 'node:worker_threads'\n\nimport {configDefinition, readConfig, type TypeGenConfig} from '@sanity/codegen'\nimport {WorkerChannelReceiver} from '@sanity/worker-channels'\nimport chalk from 'chalk'\n\nimport {type CliCommandArguments, type CliCommandContext} from '../../types'\nimport {getCliWorkerPath} from '../../util/cliWorker'\nimport {getCliConfig} from '../../util/getCliConfig'\nimport {\n  type TypegenGenerateTypesWorkerData,\n  type TypegenWorkerChannel,\n} from '../../workers/typegenGenerate'\nimport {TypesGeneratedTrace} from './generate.telemetry'\n\nexport interface TypegenGenerateTypesCommandFlags {\n  'config-path'?: string\n}\n\nconst generatedFileWarning = `/**\n * ---------------------------------------------------------------------------------\n * This file has been generated by Sanity TypeGen.\n * Command: \\`sanity typegen generate\\`\n *\n * Any modifications made directly to this file will be overwritten the next time\n * the TypeScript definitions are generated. Please make changes to the Sanity\n * schema definitions and/or GROQ queries if you need to update these types.\n *\n * For more information on how to use Sanity TypeGen, visit the official documentation:\n * https://www.sanity.io/docs/sanity-typegen\n * ---------------------------------------------------------------------------------\n */\\n\\n`\n\nasync function getConfig(\n  workDir: string,\n  configPath?: string,\n): Promise<{config: TypeGenConfig; path?: string; type: 'legacy' | 'cli'}> {\n  const config = await getCliConfig(workDir)\n\n  // check if the legacy config exist\n  const legacyConfigPath = configPath || 'sanity-typegen.json'\n  let hasLegacyConfig = false\n  try {\n    const file = await stat(legacyConfigPath)\n    hasLegacyConfig = file.isFile()\n  } catch (err) {\n    if (err.code === 'ENOENT' && configPath) {\n      throw new Error(`Typegen config file not found: ${configPath}`, {cause: err})\n    }\n\n    if (err.code !== 'ENOENT') {\n      throw new Error(`Error when checking if typegen config file exists: ${legacyConfigPath}`, {\n        cause: err,\n      })\n    }\n  }\n\n  // we have both legacy and cli config with typegen\n  if (config?.config?.typegen && hasLegacyConfig) {\n    console.warn(\n      chalk.yellow(\n        `You've specified typegen in your Sanity CLI config, but also have a typegen config.\n\nThe config from the Sanity CLI config is used.\n`,\n      ),\n    )\n\n    return {\n      config: configDefinition.parse(config.config.typegen || {}),\n      path: config.path,\n      type: 'cli',\n    }\n  }\n\n  // we only have legacy typegen config\n  if (hasLegacyConfig) {\n    console.warn(\n      chalk.yellow(\n        `The separate typegen config has been deprecated. Use \\`typegen\\` in the sanity CLI config instead.\n\nSee: https://www.sanity.io/docs/help/configuring-typegen-in-sanity-cli-config`,\n      ),\n    )\n    return {\n      config: await readConfig(legacyConfigPath),\n      path: legacyConfigPath,\n      type: 'legacy',\n    }\n  }\n\n  // we only have cli config\n  return {\n    config: configDefinition.parse(config?.config?.typegen || {}),\n    path: config?.path,\n    type: 'cli',\n  }\n}\n\nconst formatter = new Intl.NumberFormat('en-US', {\n  style: 'percent',\n  minimumFractionDigits: 1,\n  maximumFractionDigits: 1,\n})\nconst percent = (value: number): string => formatter.format(Math.min(value, 1))\nconst count = (\n  amount: number,\n  plural: string = '',\n  singular: string = plural.slice(0, Math.max(0, plural.length - 1)),\n): string =>\n  [amount.toLocaleString('en-US'), amount === 1 ? singular : plural].filter(Boolean).join(' ')\nconst getMessage = (error: unknown) =>\n  typeof error === 'object' && !!error && 'message' in error && typeof error.message === 'string'\n    ? error.message\n    : 'Unknown error'\n\nexport default async function typegenGenerateAction(\n  {extOptions: flags}: CliCommandArguments<TypegenGenerateTypesCommandFlags>,\n  {output, workDir, telemetry}: CliCommandContext,\n): Promise<void> {\n  const trace = telemetry.trace(TypesGeneratedTrace)\n  trace.start()\n\n  const spinner = output.spinner({}).start('Loading config…')\n\n  const {\n    config: typegenConfig,\n    type: typegenConfigMethod,\n    path: configPath,\n  } = await getConfig(workDir, flags['config-path'])\n\n  spinner.succeed(`Config loaded from ${configPath?.replace(workDir, '.')}`)\n\n  const {\n    generates,\n    path: searchPath,\n    schema: schemaPath,\n    formatGeneratedCode,\n    overloadClientMethods,\n  } = typegenConfig\n\n  const outputPath = isAbsolute(typegenConfig.generates)\n    ? typegenConfig.generates\n    : join(workDir, typegenConfig.generates)\n\n  const outputDir = dirname(outputPath)\n  await mkdir(outputDir, {recursive: true})\n\n  const workerPath = await getCliWorkerPath('typegenGenerate')\n  const workerData: TypegenGenerateTypesWorkerData = {\n    workDir,\n    schemaPath,\n    searchPath,\n    overloadClientMethods,\n  }\n  const worker = new Worker(workerPath, {workerData, env})\n  const receiver = WorkerChannelReceiver.from<TypegenWorkerChannel>(worker)\n\n  try {\n    spinner.start(`Loading schema…`)\n    await receiver.event.loadedSchema()\n    spinner.succeed(`Schema loaded from ${schemaPath}`)\n\n    spinner.start('Generating schema types…')\n    const {expectedFileCount} = await receiver.event.typegenStarted()\n    const {schemaTypeDeclarations} = await receiver.event.generatedSchemaTypes()\n    const schemaTypesCount = schemaTypeDeclarations.length\n    spinner.succeed(`Generated ${count(schemaTypesCount, 'schema types')}`)\n\n    spinner.start('Generating query types…')\n    let queriesCount = 0\n    let evaluatedFiles = 0\n    let filesWithErrors = 0\n    let queryFilesCount = 0\n    let typeNodesGenerated = 0\n    let unknownTypeNodesGenerated = 0\n    let emptyUnionTypeNodesGenerated = 0\n\n    for await (const {queries, errors} of receiver.stream.evaluatedModules()) {\n      evaluatedFiles++\n      queriesCount += queries.length\n      queryFilesCount += queries.length ? 1 : 0\n      filesWithErrors += errors.length ? 1 : 0\n\n      for (const {stats} of queries) {\n        typeNodesGenerated += stats.allTypes\n        unknownTypeNodesGenerated += stats.unknownTypes\n        emptyUnionTypeNodesGenerated += stats.emptyUnions\n      }\n\n      for (const error of errors) {\n        spinner.fail(getMessage(error))\n      }\n\n      spinner.text =\n        `Generating query types… (${percent(evaluatedFiles / expectedFileCount)})\\n` +\n        `  └─ Processed ${count(evaluatedFiles)} of ${count(expectedFileCount, 'files')}. ` +\n        `Found ${count(queriesCount, 'queries', 'query')} from ${count(queryFilesCount, 'files')}.`\n    }\n\n    const result = await receiver.event.typegenComplete()\n    const code = `${generatedFileWarning}${result.code}`\n    await writeFile(outputPath, code)\n\n    spinner.succeed(\n      `Generated ${count(queriesCount, 'query types')} from ${count(queryFilesCount, 'files')} out of ${count(evaluatedFiles, 'scanned files')}`,\n    )\n\n    if (formatGeneratedCode) {\n      spinner.start(`Formatting generated types with prettier…`)\n\n      try {\n        const prettier = await import('prettier')\n        const prettierConfig = await prettier.resolveConfig(outputPath)\n        const formattedCode = await prettier.format(code, {\n          ...prettierConfig,\n          parser: 'typescript' as const,\n        })\n        await writeFile(outputPath, formattedCode)\n\n        spinner.succeed('Formatted generated types with prettier')\n      } catch (err) {\n        spinner.warn(`Failed to format generated types with prettier: ${getMessage(err)}`)\n      }\n    }\n\n    trace.log({\n      configOverloadClientMethods: overloadClientMethods,\n      outputSize: Buffer.byteLength(result.code),\n      queriesCount,\n      schemaTypesCount,\n      queryFilesCount,\n      filesWithErrors,\n      typeNodesGenerated,\n      unknownTypeNodesGenerated,\n      emptyUnionTypeNodesGenerated,\n      unknownTypeNodesRatio:\n        typeNodesGenerated > 0 ? unknownTypeNodesGenerated / typeNodesGenerated : 0,\n      configMethod: typegenConfigMethod,\n    })\n\n    if (filesWithErrors > 0) {\n      spinner.warn(\n        `Encountered errors in ${count(filesWithErrors, 'files')} while generating types`,\n      )\n    }\n\n    spinner.succeed(`Successfully generated types to ${generates}`)\n  } catch (err) {\n    trace.error(err)\n    throw err\n  } finally {\n    receiver.unsubscribe()\n    trace.complete()\n    await worker.terminate()\n  }\n}\n"],"names":["defineTrace","getCliConfig","stat","chalk","configDefinition","readConfig","telemetry","isAbsolute","join","dirname","mkdir","getCliWorkerPath","Worker","env","WorkerChannelReceiver","writeFile"],"mappings":"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"}