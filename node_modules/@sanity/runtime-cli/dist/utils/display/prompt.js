import { confirm, input, Separator, select } from '@inquirer/prompts';
import chalk from 'chalk';
import { createEmptyStack, listStacks } from '../../actions/blueprints/stacks.js';
import { groupProjectsByOrganization } from '../../actions/sanity/projects.js';
import { niceId } from './presenters.js';
export async function promptForBlueprintType() {
    return await select({
        message: 'Choose a Blueprint file type:',
        choices: [
            { name: 'TypeScript', value: 'ts' },
            { name: 'JavaScript', value: 'js' },
            { name: 'JSON', value: 'json' },
        ],
        default: 'ts',
    });
}
/**
 * Prompt the user for a Project after selecting an Organization.
 * @param token - The Sanity API token
 * @returns The selected project, with the projectId and displayName
 * @throws {Error} If the user does not have any projects or if the API call fails
 */
export async function promptForProject({ token, knownOrganizationId, knownProjectId, }) {
    const { ok, error, organizations } = await groupProjectsByOrganization({ token });
    if (!ok) {
        throw new Error(error ?? 'Unknown error listing projects');
    }
    if (organizations.length === 0) {
        throw new Error('No Sanity projects found. Use `npx sanity init` to create one.');
    }
    let projects;
    if (organizations.length > 1) {
        const orgChoices = organizations.map(({ organization, projects }) => ({
            name: `"${organization.name}" ${niceId(organization.id)}`,
            value: { organization, projects },
            disabled: !projects || projects.length === 0 ? '(0 Projects)' : false,
        }));
        const pickedOrganization = await select({
            message: 'Which Organization would you like to use?',
            choices: orgChoices,
            default: knownOrganizationId,
        });
        projects = pickedOrganization.projects;
    }
    else {
        projects = organizations[0].projects;
    }
    const projectChoices = projects.map(({ displayName, id: projectId }) => ({
        name: `"${displayName}" ${niceId(projectId)}`,
        value: { projectId, displayName },
    }));
    let pickedProject;
    if (projectChoices.length === 1) {
        const onlyProject = projectChoices[0];
        const confirmed = await confirm({
            message: `Found 1 project. Use ${onlyProject.name}?`,
            default: true,
        });
        if (confirmed)
            pickedProject = onlyProject.value;
        else
            throw new Error('No project selected');
    }
    else {
        pickedProject = await select({
            message: 'Choose a Sanity Project:',
            choices: projectChoices,
            default: knownProjectId,
        });
    }
    return pickedProject;
}
/**
 * Prompt the user for a Stack ID after selecting a Project.
 * Can be used to create a new Stack or select an existing one.
 * @param projectId - The ID of the Project
 * @param token - The Sanity API token
 * @returns The selected Stack ID
 * @throws {Error} If the user does not have any Stacks or if the API call fails
 */
export async function promptForStack({ projectId, token, }) {
    const { ok: stacksOk, error: stacksErr, stacks, } = await listStacks({ token, scopeType: 'project', scopeId: projectId });
    if (!stacksOk) {
        throw new Error(stacksErr || 'Failed to list Stacks');
    }
    const newStackValue = { id: 'new', name: 'new' };
    let pickedStackId = newStackValue;
    if (stacks.length > 0) {
        const stackChoices = [];
        stackChoices.push(new Separator(chalk.underline('Create a new Stack:')));
        stackChoices.push({ name: chalk.bold('New Stack âœ¨'), value: newStackValue });
        stackChoices.push(new Separator(chalk.underline('Use an existing Stack:')));
        stackChoices.push(...stacks.map((s) => ({
            name: `"${s.name}" ${niceId(s.id)} ${chalk.dim(`(${s.resources.length} res)`)}`,
            value: { id: s.id, name: s.name },
        })));
        pickedStackId = await select({
            message: 'Select a deployment Stack:',
            choices: stackChoices,
            default: newStackValue,
        });
    }
    if (pickedStackId.id === 'new') {
        const stackName = await input({
            message: 'Enter a name for your new Stack:',
            validate: (input) => input.length > 0 || 'Stack name is required',
        });
        const stack = await createEmptyStack({
            token,
            scopeType: 'project',
            scopeId: projectId,
            name: stackName,
        });
        return { stackId: stack.id, name: stackName };
    }
    return { stackId: pickedStackId.id, name: pickedStackId.name };
}
