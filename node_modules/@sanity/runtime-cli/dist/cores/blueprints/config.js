import chalk from 'chalk';
import { patchConfigFile, writeConfigFile, } from '../../actions/blueprints/config.js';
import { filePathRelativeToCwd, labeledId, warn } from '../../utils/display/presenters.js';
import { promptForProject, promptForStack } from '../../utils/display/prompt.js';
export async function blueprintConfigCore(options) {
    const { bin = 'sanity', blueprint, log, token, flags } = options;
    const { edit: editConfig = false, 'project-id': flagProjectId, 'organization-id': flagOrganizationId, 'stack-id': flagStackId, verbose: v = false, } = flags;
    const providedConfigFlag = [flagProjectId, flagStackId, flagOrganizationId].some(Boolean);
    const { stackId: configStackId, scopeType: configScopeType, scopeId: configScopeId, blueprintConfig, fileInfo, } = blueprint;
    const blueprintFilePath = fileInfo.blueprintFilePath;
    if (!configStackId && !configScopeType && !configScopeId) {
        log(warn('Incomplete configuration.'));
        if (!editConfig) {
            // blueprint.json exists but no config JSON
            log(`Run \`${bin} blueprints doctor\` for diagnostics.`);
            return { success: true }; // not necessarily fatal
        }
    }
    if (blueprintConfig)
        printConfig({ configLabel: 'Current', log, config: blueprintConfig, v });
    // passing new config without --edit flag is not allowed
    if (providedConfigFlag && !editConfig) {
        log('To update the configuration, use the --edit flag.');
        return { success: true };
    }
    if (!editConfig) {
        // no edit; return success early
        return { success: true };
    }
    else {
        if (providedConfigFlag) {
            // if a config property flag was passed, set the value and return success
            // do not try to validate correctness of combined flags; this should not be interactive
            const configUpdate = {};
            if (flagProjectId)
                configUpdate.projectId = flagProjectId;
            if (flagStackId)
                configUpdate.stackId = flagStackId;
            if (flagOrganizationId)
                configUpdate.organizationId = flagOrganizationId;
            try {
                const newConfig = patchConfigFile(blueprintFilePath, configUpdate);
                printConfig({ configLabel: 'Updated', log, config: newConfig, v });
                return { success: true };
            }
            catch {
                return { success: false, error: 'Unable to update configuration.' };
            }
        }
        // prompt for values interactively
        // do not yet offer organization as scope option
        let updatedProjectId = flagProjectId;
        if (!updatedProjectId) {
            const pickedProject = await promptForProject({
                token,
                knownProjectId: configScopeId,
            });
            updatedProjectId = pickedProject.projectId;
        }
        if (!updatedProjectId)
            return { success: false, error: 'Project ID is required.' };
        let updatedStackId = flagStackId;
        if (!updatedStackId) {
            const pickedStack = await promptForStack({ projectId: updatedProjectId, token });
            updatedStackId = pickedStack.stackId;
        }
        if (!updatedStackId)
            return { success: false, error: 'Stack is required.' };
        try {
            // update or create config JSON
            const newConfig = await writeConfigFile(blueprintFilePath, {
                projectId: updatedProjectId,
                stackId: updatedStackId,
            });
            printConfig({ configLabel: 'Updated', log, config: newConfig, v });
            return { success: true };
        }
        catch {
            return { success: false, error: 'Unable to update configuration!' };
        }
    }
}
function printConfig(options) {
    const { configLabel, log, config, v = false } = options;
    const { projectId, organizationId, stackId, updatedAt } = config;
    const scopeType = projectId ? 'project' : 'organization';
    const scopeId = projectId ? projectId : organizationId;
    if (v)
        log(JSON.stringify(config));
    log(`${chalk.bold(`${configLabel} configuration:`)}`);
    log(`  Deployment: ${labeledId('stack', stackId)}`);
    log(`   Scoped to: ${labeledId(scopeType, scopeId)}`);
    if (updatedAt)
        log(`     Updated: ${new Date(updatedAt).toLocaleString()}`);
    if ('configPath' in config) {
        const { configPath } = config;
        if (configPath)
            log(`        File: ${filePathRelativeToCwd(configPath)}`);
    }
}
