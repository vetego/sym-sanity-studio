import { Args, Flags } from '@oclif/core';
import { BlueprintCommand } from '../../baseCommands.js';
import { functionTestCore } from '../../cores/functions/test.js';
export default class TestCommand extends BlueprintCommand {
    static args = {
        name: Args.string({ description: 'The name of the Sanity Function', required: true }),
    };
    static description = 'Invoke a local Sanity Function';
    static examples = [
        `<%= config.bin %> <%= command.id %> <name> --data '{ "id": 1 }'`,
        `<%= config.bin %> <%= command.id %> <name> --file 'payload.json'`,
        `<%= config.bin %> <%= command.id %> <name> --data '{ "id": 1 }' --timeout 60`,
        `<%= config.bin %> <%= command.id %> <name> --event update --data-before '{ "title": "before" }' --data-after '{ "title": "after" }'`,
    ];
    static flags = {
        data: Flags.string({
            char: 'd',
            description: 'Data to send to the function',
            exclusive: ['file', 'document-id'],
            required: false,
        }),
        'data-before': Flags.string({
            description: 'Original document',
            exclusive: [
                'data',
                'file',
                'document-id',
                'file-before',
                'file-after',
                'document-id-before',
                'document-id-after',
            ],
            required: false,
        }),
        'data-after': Flags.string({
            description: 'Current document',
            exclusive: [
                'data',
                'file',
                'document-id',
                'file-before',
                'file-after',
                'document-id-before',
                'document-id-after',
            ],
            required: false,
        }),
        event: Flags.string({
            char: 'e',
            description: 'Type of event (create, update, delete)',
            required: false,
            options: ['create', 'update', 'delete'],
        }),
        file: Flags.string({
            char: 'f',
            description: 'Read data from file and send to the function',
            exclusive: ['data', 'document-id'],
            required: false,
        }),
        'file-before': Flags.string({
            description: 'Original document',
            exclusive: [
                'data',
                'file',
                'document-id',
                'data-before',
                'data-after',
                'document-id-before',
                'document-id-after',
            ],
            required: false,
        }),
        'file-after': Flags.string({
            description: 'Current document',
            exclusive: [
                'data',
                'file',
                'document-id',
                'data-before',
                'data-after',
                'document-id-before',
                'document-id-after',
            ],
            required: false,
        }),
        timeout: Flags.integer({
            char: 't',
            description: 'Execution timeout value in seconds',
            required: false,
        }),
        api: Flags.string({
            char: 'a',
            description: 'Sanity API Version to use',
            required: false,
        }),
        dataset: Flags.string({
            description: 'The Sanity dataset to use',
            required: false,
        }),
        'project-id': Flags.string({
            description: 'Sanity Project ID to use',
            aliases: ['project', 'projectId'],
            required: false,
        }),
        'organization-id': Flags.string({
            description: 'Sanity Organization ID to use',
            aliases: ['organization', 'organizationId', 'org'],
            required: false,
        }),
        'document-id': Flags.string({
            description: 'Document to fetch and send to function',
            aliases: ['doc', 'documentId'],
            exclusive: ['data', 'file'],
            required: false,
        }),
        'document-id-before': Flags.string({
            description: 'Original document',
            exclusive: [
                'data',
                'file',
                'document-id',
                'data-before',
                'data-after',
                'file-before',
                'file-after',
            ],
            required: false,
        }),
        'document-id-after': Flags.string({
            description: 'Current document',
            exclusive: [
                'data',
                'file',
                'document-id',
                'data-before',
                'data-after',
                'file-before',
                'file-after',
            ],
            required: false,
        }),
        'with-user-token': Flags.boolean({
            description: 'Prime access token from CLI config',
            default: false,
        }),
        'media-library-id': Flags.string({
            description: 'Sanity Media Library ID to use',
            aliases: ['media'],
            exclusive: ['project-id', 'dataset'],
            required: false,
        }),
    };
    async run() {
        if (this.flags.event === 'update') {
            const hasDataPair = this.flags['data-before'] && this.flags['data-after'];
            const hasFilePair = this.flags['file-before'] && this.flags['file-after'];
            const hasDocPair = this.flags['document-id-before'] && this.flags['document-id-after'];
            if (!(hasDataPair || hasFilePair || hasDocPair)) {
                this.error('When using --event=update, you must provide one of the following flag pairs:\n' +
                    '  --data-before and --data-after\n' +
                    '  --file-before and --file-after\n' +
                    '  --document-id-before and --document-id-after');
            }
        }
        const { success, error } = await functionTestCore({
            bin: this.config.bin,
            log: (msg) => this.log(msg),
            args: this.args,
            flags: this.flags,
            blueprint: this.blueprint,
        });
        if (!success)
            this.error(error);
    }
}
