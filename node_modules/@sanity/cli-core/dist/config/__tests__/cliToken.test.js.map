{"version":3,"sources":["../../../src/config/__tests__/cliToken.test.ts"],"sourcesContent":["import {afterEach, beforeEach, describe, expect, it, vi} from 'vitest'\n\nimport {getConfig} from '../../services/cliUserConfig'\nimport * as cliTokenModule from '../../services/getCliToken'\n\nvi.mock('../../services/cliUserConfig', () => ({\n  getConfig: vi.fn(),\n}))\n\ndescribe('getCliToken', () => {\n  const originalEnv = process.env\n  let cachedToken: string | undefined\n\n  beforeEach(() => {\n    process.env = {...originalEnv}\n    vi.clearAllMocks()\n    vi.resetModules()\n    cachedToken = undefined\n    vi.spyOn(cliTokenModule, 'getCliToken').mockImplementation(async () => {\n      if (cachedToken !== undefined) {\n        return cachedToken\n      }\n\n      const token = process.env.SANITY_AUTH_TOKEN\n      if (token) {\n        cachedToken = token.trim()\n        return cachedToken\n      }\n\n      cachedToken = await getConfig('authToken')\n      return cachedToken\n    })\n  })\n\n  afterEach(() => {\n    process.env = originalEnv\n    vi.restoreAllMocks()\n  })\n\n  it('should return token from environment variable', async () => {\n    process.env.SANITY_AUTH_TOKEN = 'test-token'\n    const token = await cliTokenModule.getCliToken()\n    expect(token).toBe('test-token')\n    expect(getConfig).not.toHaveBeenCalled()\n  })\n\n  it('should return token from config if no environment variable is set', async () => {\n    delete process.env.SANITY_AUTH_TOKEN\n    vi.mocked(getConfig).mockResolvedValueOnce('config-token')\n\n    const token = await cliTokenModule.getCliToken()\n    expect(token).toBe('config-token')\n    expect(getConfig).toHaveBeenCalledWith('authToken')\n  })\n\n  it('should return undefined if no token is available', async () => {\n    delete process.env.SANITY_AUTH_TOKEN\n    vi.mocked(getConfig).mockResolvedValueOnce(undefined)\n\n    const token = await cliTokenModule.getCliToken()\n    expect(token).toBeUndefined()\n    expect(getConfig).toHaveBeenCalledWith('authToken')\n  })\n\n  it('should cache the token from environment variable', async () => {\n    process.env.SANITY_AUTH_TOKEN = 'cached-env-token'\n\n    const firstCall = await cliTokenModule.getCliToken()\n    process.env.SANITY_AUTH_TOKEN = 'new-token'\n    const secondCall = await cliTokenModule.getCliToken()\n\n    expect(firstCall).toBe('cached-env-token')\n    expect(secondCall).toBe('cached-env-token')\n    expect(getConfig).not.toHaveBeenCalled()\n  })\n\n  it('should cache the token from config', async () => {\n    delete process.env.SANITY_AUTH_TOKEN\n    vi.mocked(getConfig).mockResolvedValueOnce('cached-config-token')\n\n    const firstCall = await cliTokenModule.getCliToken()\n    const secondCall = await cliTokenModule.getCliToken()\n\n    expect(firstCall).toBe('cached-config-token')\n    expect(secondCall).toBe('cached-config-token')\n    expect(getConfig).toHaveBeenCalledTimes(1)\n  })\n})\n"],"names":["afterEach","beforeEach","describe","expect","it","vi","getConfig","cliTokenModule","mock","fn","originalEnv","process","env","cachedToken","clearAllMocks","resetModules","undefined","spyOn","mockImplementation","token","SANITY_AUTH_TOKEN","trim","restoreAllMocks","getCliToken","toBe","not","toHaveBeenCalled","mocked","mockResolvedValueOnce","toHaveBeenCalledWith","toBeUndefined","firstCall","secondCall","toHaveBeenCalledTimes"],"mappings":"AAAA,SAAQA,SAAS,EAAEC,UAAU,EAAEC,QAAQ,EAAEC,MAAM,EAAEC,EAAE,EAAEC,EAAE,QAAO,SAAQ;AAEtE,SAAQC,SAAS,QAAO,+BAA8B;AACtD,YAAYC,oBAAoB,6BAA4B;AAE5DF,GAAGG,IAAI,CAAC,gCAAgC,IAAO,CAAA;QAC7CF,WAAWD,GAAGI,EAAE;IAClB,CAAA;AAEAP,SAAS,eAAe;IACtB,MAAMQ,cAAcC,QAAQC,GAAG;IAC/B,IAAIC;IAEJZ,WAAW;QACTU,QAAQC,GAAG,GAAG;YAAC,GAAGF,WAAW;QAAA;QAC7BL,GAAGS,aAAa;QAChBT,GAAGU,YAAY;QACfF,cAAcG;QACdX,GAAGY,KAAK,CAACV,gBAAgB,eAAeW,kBAAkB,CAAC;YACzD,IAAIL,gBAAgBG,WAAW;gBAC7B,OAAOH;YACT;YAEA,MAAMM,QAAQR,QAAQC,GAAG,CAACQ,iBAAiB;YAC3C,IAAID,OAAO;gBACTN,cAAcM,MAAME,IAAI;gBACxB,OAAOR;YACT;YAEAA,cAAc,MAAMP,UAAU;YAC9B,OAAOO;QACT;IACF;IAEAb,UAAU;QACRW,QAAQC,GAAG,GAAGF;QACdL,GAAGiB,eAAe;IACpB;IAEAlB,GAAG,iDAAiD;QAClDO,QAAQC,GAAG,CAACQ,iBAAiB,GAAG;QAChC,MAAMD,QAAQ,MAAMZ,eAAegB,WAAW;QAC9CpB,OAAOgB,OAAOK,IAAI,CAAC;QACnBrB,OAAOG,WAAWmB,GAAG,CAACC,gBAAgB;IACxC;IAEAtB,GAAG,qEAAqE;QACtE,OAAOO,QAAQC,GAAG,CAACQ,iBAAiB;QACpCf,GAAGsB,MAAM,CAACrB,WAAWsB,qBAAqB,CAAC;QAE3C,MAAMT,QAAQ,MAAMZ,eAAegB,WAAW;QAC9CpB,OAAOgB,OAAOK,IAAI,CAAC;QACnBrB,OAAOG,WAAWuB,oBAAoB,CAAC;IACzC;IAEAzB,GAAG,oDAAoD;QACrD,OAAOO,QAAQC,GAAG,CAACQ,iBAAiB;QACpCf,GAAGsB,MAAM,CAACrB,WAAWsB,qBAAqB,CAACZ;QAE3C,MAAMG,QAAQ,MAAMZ,eAAegB,WAAW;QAC9CpB,OAAOgB,OAAOW,aAAa;QAC3B3B,OAAOG,WAAWuB,oBAAoB,CAAC;IACzC;IAEAzB,GAAG,oDAAoD;QACrDO,QAAQC,GAAG,CAACQ,iBAAiB,GAAG;QAEhC,MAAMW,YAAY,MAAMxB,eAAegB,WAAW;QAClDZ,QAAQC,GAAG,CAACQ,iBAAiB,GAAG;QAChC,MAAMY,aAAa,MAAMzB,eAAegB,WAAW;QAEnDpB,OAAO4B,WAAWP,IAAI,CAAC;QACvBrB,OAAO6B,YAAYR,IAAI,CAAC;QACxBrB,OAAOG,WAAWmB,GAAG,CAACC,gBAAgB;IACxC;IAEAtB,GAAG,sCAAsC;QACvC,OAAOO,QAAQC,GAAG,CAACQ,iBAAiB;QACpCf,GAAGsB,MAAM,CAACrB,WAAWsB,qBAAqB,CAAC;QAE3C,MAAMG,YAAY,MAAMxB,eAAegB,WAAW;QAClD,MAAMS,aAAa,MAAMzB,eAAegB,WAAW;QAEnDpB,OAAO4B,WAAWP,IAAI,CAAC;QACvBrB,OAAO6B,YAAYR,IAAI,CAAC;QACxBrB,OAAOG,WAAW2B,qBAAqB,CAAC;IAC1C;AACF"}