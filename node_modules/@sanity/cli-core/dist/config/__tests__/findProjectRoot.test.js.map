{"version":3,"sources":["../../../src/config/__tests__/findProjectRoot.test.ts"],"sourcesContent":["import {access} from 'node:fs/promises'\nimport {join} from 'node:path'\n\nimport {afterEach, beforeEach, describe, expect, test, vi} from 'vitest'\n\nimport {readJsonFile} from '../../util/readJsonFile'\nimport {findProjectRoot} from '../findProjectRoot'\n\n// Mock the fs/promises module\nvi.mock('node:fs/promises', () => ({\n  access: vi.fn(),\n}))\n\n// Mock the readJsonFile utility\nvi.mock('../../util/readJsonFile', () => ({\n  readJsonFile: vi.fn(),\n}))\n\ndescribe('#findProjectRoot', () => {\n  const mockCwd = '/mock/project/path'\n\n  beforeEach(() => {\n    vi.clearAllMocks()\n  })\n\n  afterEach(() => {\n    vi.resetAllMocks()\n  })\n\n  test('finds a TypeScript studio config in the current directory', async () => {\n    // Mock access to return true for sanity.config.ts\n    vi.mocked(access).mockImplementation((path) => {\n      if (path === join(mockCwd, 'sanity.config.ts')) {\n        return Promise.resolve()\n      }\n      return Promise.reject(new Error('File not found'))\n    })\n\n    const result = await findProjectRoot(mockCwd)\n    expect(result).toEqual({\n      directory: mockCwd,\n      path: join(mockCwd, 'sanity.config.ts'),\n      type: 'studio',\n    })\n  })\n\n  test('finds a JavaScript studio config in the current directory', async () => {\n    // Mock access to return true for sanity.config.js\n    vi.mocked(access).mockImplementation((path) => {\n      if (path === join(mockCwd, 'sanity.config.js')) {\n        return Promise.resolve()\n      }\n      return Promise.reject(new Error('File not found'))\n    })\n\n    const result = await findProjectRoot(mockCwd)\n    expect(result).toEqual({\n      directory: mockCwd,\n      path: join(mockCwd, 'sanity.config.js'),\n      type: 'studio',\n    })\n  })\n\n  test('throws error when multiple config files are found', async () => {\n    // Mock access to return true for multiple config files\n    vi.mocked(access).mockImplementation((path) => {\n      if (\n        path === join(mockCwd, 'sanity.config.ts') ||\n        path === join(mockCwd, 'sanity.config.js')\n      ) {\n        return Promise.resolve()\n      }\n      return Promise.reject(new Error('File not found'))\n    })\n\n    await expect(findProjectRoot(mockCwd)).rejects.toThrow(\n      'Multiple studio config files found (sanity.config.ts, sanity.config.js)',\n    )\n  })\n\n  test('throws error when v2 studio root is found', async () => {\n    // Mock access to reject all config files\n    vi.mocked(access).mockRejectedValue(new Error('File not found'))\n\n    // Mock readJsonFile to return a v2 config\n    vi.mocked(readJsonFile).mockResolvedValue({root: true})\n\n    await expect(findProjectRoot(mockCwd)).rejects.toThrow(\n      \"Found 'sanity.json' at /mock/project/path - Sanity Studio < v3 is no longer supported\",\n    )\n  })\n\n  test('recursively searches parent directories for config', async () => {\n    const parentPath = '/mock/project'\n\n    // Mock access to return true only for config in parent directory\n    vi.mocked(access).mockImplementation((path) => {\n      if (path === join(parentPath, 'sanity.config.ts')) {\n        return Promise.resolve()\n      }\n      return Promise.reject(new Error('File not found'))\n    })\n\n    const result = await findProjectRoot(mockCwd)\n    expect(result).toEqual({\n      directory: parentPath,\n      path: join(parentPath, 'sanity.config.ts'),\n      type: 'studio',\n    })\n  })\n\n  test('throws error when no config is found', async () => {\n    // Mock access to reject all files\n    vi.mocked(access).mockRejectedValue(new Error('File not found'))\n\n    // Mock readJsonFile to return non-root config\n    vi.mocked(readJsonFile).mockResolvedValue({root: false})\n\n    await expect(findProjectRoot(mockCwd)).rejects.toThrow('No project root found')\n  })\n\n  test('throws an error if v2 studio root is found', async () => {\n    vi.mocked(readJsonFile).mockResolvedValue({root: true})\n\n    await expect(findProjectRoot(mockCwd)).rejects.toThrow(\n      \"Found 'sanity.json' at /mock/project/path - Sanity Studio < v3 is no longer supported\",\n    )\n  })\n\n  test('finds a TypeScript app config in the current directory', async () => {\n    // Mock access to return true for sanity.cli.ts\n    vi.mocked(access).mockImplementation((path) => {\n      if (path === join(mockCwd, 'sanity.cli.ts')) {\n        return Promise.resolve()\n      }\n      return Promise.reject(new Error('File not found'))\n    })\n\n    const result = await findProjectRoot(mockCwd)\n    expect(result).toEqual({\n      directory: mockCwd,\n      path: join(mockCwd, 'sanity.cli.ts'),\n      type: 'app',\n    })\n  })\n\n  test('finds a JavaScript app config in the current directory', async () => {\n    // Mock access to return true for sanity.cli.js\n    vi.mocked(access).mockImplementation((path) => {\n      if (path === join(mockCwd, 'sanity.cli.js')) {\n        return Promise.resolve()\n      }\n      return Promise.reject(new Error('File not found'))\n    })\n\n    const result = await findProjectRoot(mockCwd)\n    expect(result).toEqual({\n      directory: mockCwd,\n      path: join(mockCwd, 'sanity.cli.js'),\n      type: 'app',\n    })\n  })\n\n  test('throws error when multiple app config files are found', async () => {\n    // Mock access to return true for multiple app config files\n    vi.mocked(access).mockImplementation((path) => {\n      if (path === join(mockCwd, 'sanity.cli.ts') || path === join(mockCwd, 'sanity.cli.js')) {\n        return Promise.resolve()\n      }\n      return Promise.reject(new Error('File not found'))\n    })\n\n    await expect(findProjectRoot(mockCwd)).rejects.toThrow('Multiple app config files found')\n  })\n\n  test('prioritizes studio config over app config when both are present', async () => {\n    // Mock access to return true for both studio and app config files\n    vi.mocked(access).mockImplementation((path) => {\n      if (path === join(mockCwd, 'sanity.config.ts') || path === join(mockCwd, 'sanity.cli.ts')) {\n        return Promise.resolve()\n      }\n      return Promise.reject(new Error('File not found'))\n    })\n\n    const result = await findProjectRoot(mockCwd)\n    expect(result).toEqual({\n      directory: mockCwd,\n      path: join(mockCwd, 'sanity.config.ts'),\n      type: 'studio',\n    })\n  })\n})\n"],"names":["access","join","afterEach","beforeEach","describe","expect","test","vi","readJsonFile","findProjectRoot","mock","fn","mockCwd","clearAllMocks","resetAllMocks","mocked","mockImplementation","path","Promise","resolve","reject","Error","result","toEqual","directory","type","rejects","toThrow","mockRejectedValue","mockResolvedValue","root","parentPath"],"mappings":"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"}