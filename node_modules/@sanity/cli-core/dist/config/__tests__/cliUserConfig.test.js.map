{"version":3,"sources":["../../../src/config/__tests__/cliUserConfig.test.ts"],"sourcesContent":["import {mkdir} from 'node:fs/promises'\nimport {homedir} from 'node:os'\n\nimport {afterEach, beforeEach, describe, expect, test, vi} from 'vitest'\n\nimport {getConfig, setConfig} from '../../services/cliUserConfig'\nimport {readJsonFile} from '../../util/readJsonFile'\nimport {writeJsonFile} from '../../util/writeJsonFile'\n\nvi.mock('node:fs/promises')\nvi.mock('node:os')\nvi.mock('../../util/readJsonFile')\nvi.mock('../../util/writeJsonFile')\n\nconst mockHomedir = '/mock/home/dir'\n\ndescribe('cliUserConfig', () => {\n  beforeEach(() => {\n    vi.resetAllMocks()\n    vi.mocked(homedir).mockReturnValue(mockHomedir)\n    vi.mocked(mkdir).mockResolvedValue(undefined)\n    vi.mocked(readJsonFile).mockResolvedValue({})\n    vi.mocked(writeJsonFile).mockResolvedValue()\n  })\n\n  afterEach(() => {\n    vi.resetAllMocks()\n  })\n\n  describe('readConfig behavior', () => {\n    test('returns empty config when file read fails', async () => {\n      vi.mocked(readJsonFile).mockRejectedValueOnce(new Error('File not found'))\n      const result = await getConfig('authToken')\n      expect(result).toBeUndefined()\n    })\n\n    test('returns empty config when file content is null', async () => {\n      vi.mocked(readJsonFile).mockResolvedValueOnce(null)\n      const result = await getConfig('authToken')\n      expect(result).toBeUndefined()\n    })\n\n    test('returns empty config when file content is an array', async () => {\n      vi.mocked(readJsonFile).mockResolvedValueOnce([])\n      const result = await getConfig('authToken')\n      expect(result).toBeUndefined()\n    })\n\n    test('returns empty config when file content is not an object', async () => {\n      vi.mocked(readJsonFile).mockResolvedValueOnce('not an object')\n      const result = await getConfig('authToken')\n      expect(result).toBeUndefined()\n    })\n  })\n\n  describe('getConfig', () => {\n    test('returns authToken when valid', async () => {\n      vi.mocked(readJsonFile).mockResolvedValueOnce({\n        authToken: 'test-token',\n      })\n\n      const result = await getConfig('authToken')\n      expect(result).toBe('test-token')\n    })\n\n    test('returns undefined when authToken is not set', async () => {\n      vi.mocked(readJsonFile).mockResolvedValueOnce({})\n\n      const result = await getConfig('authToken')\n      expect(result).toBeUndefined()\n    })\n\n    test('returns telemetryConsent when valid', async () => {\n      const mockConsent = {\n        updatedAt: Date.now(),\n        value: {\n          status: 'granted',\n          type: 'explicit',\n        },\n      }\n      vi.mocked(readJsonFile).mockResolvedValueOnce({\n        telemetryConsent: mockConsent,\n      })\n\n      const result = await getConfig('telemetryConsent')\n      expect(result).toEqual(mockConsent)\n    })\n\n    test('throws error for invalid property', async () => {\n      await expect(getConfig('invalidProp' as never)).rejects.toThrow('No schema defined')\n    })\n\n    test('throws error for invalid value type', async () => {\n      vi.mocked(readJsonFile).mockResolvedValueOnce({\n        authToken: 123, // Invalid type, should be string\n      })\n\n      await expect(getConfig('authToken')).rejects.toThrow('Invalid value')\n    })\n  })\n\n  describe('setConfig', () => {\n    test('sets valid authToken', async () => {\n      await setConfig('authToken', 'new-token')\n\n      expect(mkdir).toHaveBeenCalledWith(expect.any(String), {recursive: true})\n      expect(writeJsonFile).toHaveBeenCalledWith(\n        expect.any(String),\n        expect.objectContaining({\n          authToken: 'new-token',\n        }),\n        expect.any(Object),\n      )\n    })\n\n    test('sets valid telemetryConsent', async () => {\n      const mockConsent = {\n        updatedAt: Date.now(),\n        value: {\n          status: 'granted' as const,\n          type: 'explicit',\n        },\n      }\n\n      await setConfig('telemetryConsent', mockConsent)\n\n      expect(writeJsonFile).toHaveBeenCalledWith(\n        expect.any(String),\n        expect.objectContaining({\n          telemetryConsent: mockConsent,\n        }),\n        expect.any(Object),\n      )\n    })\n\n    test('throws error for invalid property', async () => {\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      await expect(setConfig('invalidProp' as any, 'value')).rejects.toThrow('No schema defined')\n    })\n\n    test('throws error for invalid value type', async () => {\n      await expect(setConfig('authToken', 123 as never)).rejects.toThrow('Invalid value')\n    })\n\n    test('merges new config with existing config', async () => {\n      vi.mocked(readJsonFile).mockResolvedValueOnce({\n        authToken: 'existing-token',\n      })\n\n      await setConfig('telemetryConsent', {\n        updatedAt: 123,\n        value: {\n          status: 'granted' as const,\n          type: 'explicit',\n        },\n      })\n\n      expect(writeJsonFile).toHaveBeenCalledWith(\n        expect.any(String),\n        expect.objectContaining({\n          authToken: 'existing-token',\n          telemetryConsent: expect.any(Object),\n        }),\n        expect.any(Object),\n      )\n    })\n  })\n})\n"],"names":["mkdir","homedir","afterEach","beforeEach","describe","expect","test","vi","getConfig","setConfig","readJsonFile","writeJsonFile","mock","mockHomedir","resetAllMocks","mocked","mockReturnValue","mockResolvedValue","undefined","mockRejectedValueOnce","Error","result","toBeUndefined","mockResolvedValueOnce","authToken","toBe","mockConsent","updatedAt","Date","now","value","status","type","telemetryConsent","toEqual","rejects","toThrow","toHaveBeenCalledWith","any","String","recursive","objectContaining","Object"],"mappings":"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"}