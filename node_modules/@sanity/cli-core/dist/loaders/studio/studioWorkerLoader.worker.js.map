{"version":3,"sources":["../../../src/loaders/studio/studioWorkerLoader.worker.ts"],"sourcesContent":["import {resolve} from 'node:path'\nimport {pathToFileURL} from 'node:url'\nimport {isMainThread} from 'node:worker_threads'\n\nimport {moduleResolve} from 'import-meta-resolve'\nimport {createServer, type InlineConfig, loadEnv, mergeConfig} from 'vite'\nimport {ViteNodeRunner} from 'vite-node/client'\nimport {ViteNodeServer} from 'vite-node/server'\nimport {installSourcemapsSupport} from 'vite-node/source-map'\n\nimport {getCliConfig} from '../../config/cli/getCliConfig.js'\nimport {type CliConfig} from '../../config/cli/types.js'\nimport {isRecord} from '../../util/isRecord.js'\nimport {isNotFoundError} from '../../util/NotFoundError.js'\nimport * as stubs from './stubs.js'\n\nif (isMainThread) {\n  throw new Error('Should be child of thread, not the main thread')\n}\n\nconst rootPath = process.env.STUDIO_WORKER_STUDIO_ROOT_PATH\nif (!rootPath) {\n  throw new Error('Missing `STUDIO_WORKER_STUDIO_ROOT_PATH` environment variable')\n}\n\nconst workerScriptPath = process.env.STUDIO_WORKER_TASK_FILE\nif (!workerScriptPath) {\n  throw new Error('Missing `STUDIO_WORKER_TASK_FILE` environment variable')\n}\n\nconst mockStubs = stubs as Record<string, unknown>\nconst mockedGlobalThis: Record<string, unknown> = globalThis\nfor (const key in stubs) {\n  if (!(key in mockedGlobalThis)) {\n    mockedGlobalThis[key] = mockStubs[key]\n  }\n}\n\n// Doesn't have to be correct, just need the root path to be\nconst fakeConfigUrl = pathToFileURL(resolve(rootPath, 'sanity.config.mjs'))\n\n// We'll load `getStudioEnvironmentVariables` from the `sanity/cli` module installed\n// relative to where the studio is located, instead of resolving from where this CLI is\n// running in, in order to ensure we're using the same version as the studio would.\nconst sanityCliUrl = await moduleResolve('sanity/cli', fakeConfigUrl)\nconst {getStudioEnvironmentVariables} = await import(sanityCliUrl.href)\nif (typeof getStudioEnvironmentVariables !== 'function') {\n  throw new TypeError('Expected `getStudioEnvironmentVariables` from `sanity/cli` to be a function')\n}\n\nconst defaultViteConfig: InlineConfig = {\n  build: {target: 'node'},\n  configFile: false, // @todo Should use `vite` prop from `sanity.cli.ts` (if any)\n  define: {\n    ...getStudioEnvironmentVariables({jsonEncode: true, prefix: 'process.env.'}),\n  },\n  logLevel: 'error',\n  optimizeDeps: {disabled: true}, // @todo is this necessary? cant remember why was added\n  root: rootPath,\n  server: {\n    hmr: false,\n    watch: null,\n  },\n}\n\n// Allow the CLI config (`sanity.cli.(js|ts)`) to define a `vite` property which can\n// extend/modify the default vite configuration for the studio.\nlet cliConfig: CliConfig | undefined\ntry {\n  cliConfig = await getCliConfig(rootPath)\n} catch (err) {\n  if (!isNotFoundError(err)) {\n    console.warn('[warn] Failed to load CLI config:', err)\n  }\n}\n\nlet viteConfig = defaultViteConfig\nif (typeof cliConfig?.vite === 'function') {\n  viteConfig = (await cliConfig.vite(viteConfig, {\n    command: 'build',\n    isSsrBuild: true,\n    mode: 'production',\n  })) as InlineConfig\n} else if (isRecord(cliConfig?.vite)) {\n  viteConfig = mergeConfig(viteConfig, cliConfig.vite)\n}\n\n// Vite will build the files we give it - targetting Node.js instead of the browser.\n// We include the inject plugin in order to provide the stubs for the undefined global APIs.\nconst server = await createServer(viteConfig)\n\n// Bit of a hack, but seems necessary based on the `node-vite` binary implementation\nawait server.pluginContainer.buildStart({})\n\n// Load environment variables from `.env` files in the same way as Vite does.\n// Note that Sanity also provides environment variables through `process.env.*` for compat reasons,\n// and so we need to do the same here.\n// @todo is this in line with sanity?\nconst env = loadEnv(server.config.mode, server.config.envDir, '')\nfor (const key in env) {\n  process.env[key] ??= env[key]\n}\n\n// Now we're providing the glue that ensures node-specific loading and execution works.\nconst node = new ViteNodeServer(server)\n\n// Should make it easier to debug any crashes in the imported codeâ€¦\ninstallSourcemapsSupport({\n  getSourceMap: (source) => node.getSourceMap(source),\n})\n\nconst runner = new ViteNodeRunner({\n  base: server.config.base,\n  async fetchModule(id) {\n    return node.fetchModule(id)\n  },\n  resolveId(id, importer) {\n    return node.resolveId(id, importer)\n  },\n  root: server.config.root,\n})\n\n// Copied from `vite-node` - it appears that this applies the `define` config from\n// vite, but it also takes a surprisingly long time to execute. Not clear at this\n// point why this is, so we should investigate whether it's necessary or not.\nawait runner.executeId('/@vite/env')\n\nawait runner.executeId(workerScriptPath)\n"],"names":["resolve","pathToFileURL","isMainThread","moduleResolve","createServer","loadEnv","mergeConfig","ViteNodeRunner","ViteNodeServer","installSourcemapsSupport","getCliConfig","isRecord","isNotFoundError","stubs","Error","rootPath","process","env","STUDIO_WORKER_STUDIO_ROOT_PATH","workerScriptPath","STUDIO_WORKER_TASK_FILE","mockStubs","mockedGlobalThis","globalThis","key","fakeConfigUrl","sanityCliUrl","getStudioEnvironmentVariables","href","TypeError","defaultViteConfig","build","target","configFile","define","jsonEncode","prefix","logLevel","optimizeDeps","disabled","root","server","hmr","watch","cliConfig","err","console","warn","viteConfig","vite","command","isSsrBuild","mode","pluginContainer","buildStart","config","envDir","node","getSourceMap","source","runner","base","fetchModule","id","resolveId","importer","executeId"],"mappings":"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"}