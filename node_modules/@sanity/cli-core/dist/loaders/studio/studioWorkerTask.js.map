{"version":3,"sources":["../../../src/loaders/studio/studioWorkerTask.ts"],"sourcesContent":["import {Worker, type WorkerOptions} from 'node:worker_threads'\n\nimport {type RequireProps} from '../../types.js'\nimport {isRecord} from '../../util/isRecord.js'\n\n/**\n * Options for the studio worker task\n *\n * @internal\n */\ninterface StudioWorkerTaskOptions extends RequireProps<WorkerOptions, 'name'> {\n  studioRootPath: string\n}\n\n/**\n * Executes a worker file in a Sanity Studio browser context.\n *\n * This uses a combination of vite for \"bundling\" + jsdom for emulating a browser\n * environment under the hood, which means that the same thing that will work in vite\n * _should_ work in the worker - to a degree. If the user has defined any typescript\n * path aliases, these will have to be added as aliases to the vite config - the same\n * behavior as you would see with regular vite. Other things that are accounted for:\n *\n * - TypeScript support (+JSX, enums and other \"compilation needed\" features)\n * - CSS, font and other file imports will resolve to a file path\n * - CSS module imports will resolve to a javascript object of class names\n * - Environment variables are available both as `import.meta.env` and `process.env`,\n *   and `.env` files are loaded in the same way that they would in a Sanity studio.\n * - Browser globals not available in a Node.js environment but _are_ provided by JSDOM\n *   are defined directly to the Node environment as globals. While this polutes the\n *   global namespace, it is done only in the worker thread.\n * - Certain browser globals that are _not_ available in JSDOM are also provided to the\n *   global namespace - things like `requestIdleCallback`, `IntersectionObserver` etc.\n *   These are provided with a minimal stub implementation to make them not crash.\n *\n * @param filePath - Path to the worker file (`.ts` works and is encouraged)\n * @param options - Options to pass to the worker\n * @returns A promise that resolves with the message from the worker\n * @throws If the file does not exist\n * @throws If the worker exits with a non-zero code\n * @internal\n */\nexport function studioWorkerTask(\n  filePath: URL,\n  options: StudioWorkerTaskOptions,\n): Promise<unknown> {\n  return new Promise((resolve, reject) => {\n    if (!/\\.worker\\.(js|ts)$/.test(filePath.pathname)) {\n      throw new Error('Studio worker tasks must include `.worker.(js|ts)` in path')\n    }\n\n    const worker = new Worker(new URL('studioWorkerLoader.worker.js', import.meta.url), {\n      ...options,\n      env: {\n        ...(isRecord(options.env) ? options.env : process.env),\n        STUDIO_WORKER_STUDIO_ROOT_PATH: options.studioRootPath,\n        STUDIO_WORKER_TASK_FILE: filePath.pathname,\n      },\n    })\n\n    worker.addListener('error', function onWorkerError(err) {\n      reject(new Error(`Fail to load file through worker: ${err.message}`))\n      cleanup()\n    })\n    worker.addListener('exit', function onWorkerExit(code) {\n      if (code > 0) {\n        reject(new Error(`Worker exited with code ${code}`))\n      }\n    })\n    worker.addListener('messageerror', function onWorkerMessageError(err) {\n      reject(new Error(`Fail to parse message from worker: ${err}`))\n      cleanup()\n    })\n    worker.addListener('message', function onWorkerMessage(message) {\n      resolve(message)\n      cleanup()\n    })\n\n    function cleanup() {\n      // Allow the worker a _bit_ of time to clean up, but ensure that we don't have\n      // lingering processes hanging around forever if the worker doesn't exit on its\n      // own.\n      setImmediate(() => worker.terminate())\n    }\n  })\n}\n"],"names":["Worker","isRecord","studioWorkerTask","filePath","options","Promise","resolve","reject","test","pathname","Error","worker","URL","url","env","process","STUDIO_WORKER_STUDIO_ROOT_PATH","studioRootPath","STUDIO_WORKER_TASK_FILE","addListener","onWorkerError","err","message","cleanup","onWorkerExit","code","onWorkerMessageError","onWorkerMessage","setImmediate","terminate"],"mappings":"AAAA,SAAQA,MAAM,QAA2B,sBAAqB;AAG9D,SAAQC,QAAQ,QAAO,yBAAwB;AAW/C;;;;;;;;;;;;;;;;;;;;;;;;;;;CA2BC,GACD,OAAO,SAASC,iBACdC,QAAa,EACbC,OAAgC;IAEhC,OAAO,IAAIC,QAAQ,CAACC,SAASC;QAC3B,IAAI,CAAC,qBAAqBC,IAAI,CAACL,SAASM,QAAQ,GAAG;YACjD,MAAM,IAAIC,MAAM;QAClB;QAEA,MAAMC,SAAS,IAAIX,OAAO,IAAIY,IAAI,gCAAgC,YAAYC,GAAG,GAAG;YAClF,GAAGT,OAAO;YACVU,KAAK;gBACH,GAAIb,SAASG,QAAQU,GAAG,IAAIV,QAAQU,GAAG,GAAGC,QAAQD,GAAG;gBACrDE,gCAAgCZ,QAAQa,cAAc;gBACtDC,yBAAyBf,SAASM,QAAQ;YAC5C;QACF;QAEAE,OAAOQ,WAAW,CAAC,SAAS,SAASC,cAAcC,GAAG;YACpDd,OAAO,IAAIG,MAAM,CAAC,kCAAkC,EAAEW,IAAIC,OAAO,EAAE;YACnEC;QACF;QACAZ,OAAOQ,WAAW,CAAC,QAAQ,SAASK,aAAaC,IAAI;YACnD,IAAIA,OAAO,GAAG;gBACZlB,OAAO,IAAIG,MAAM,CAAC,wBAAwB,EAAEe,MAAM;YACpD;QACF;QACAd,OAAOQ,WAAW,CAAC,gBAAgB,SAASO,qBAAqBL,GAAG;YAClEd,OAAO,IAAIG,MAAM,CAAC,mCAAmC,EAAEW,KAAK;YAC5DE;QACF;QACAZ,OAAOQ,WAAW,CAAC,WAAW,SAASQ,gBAAgBL,OAAO;YAC5DhB,QAAQgB;YACRC;QACF;QAEA,SAASA;YACP,8EAA8E;YAC9E,+EAA+E;YAC/E,OAAO;YACPK,aAAa,IAAMjB,OAAOkB,SAAS;QACrC;IACF;AACF"}