import { validateDocumentFunction, validateFunction, validateMediaLibraryAssetFunction, } from '../index.js';
import { runValidation } from '../utils/validation.js';
const BASE_EVENT_KEYS = new Set(['on', 'filter', 'projection', 'includeDrafts']);
const DOCUMENT_EVENT_KEYS = new Set(['includeAllVersions', 'resource', ...BASE_EVENT_KEYS.values()]);
const MEDIA_LIBRARY_EVENT_KEYS = new Set(['resource', ...BASE_EVENT_KEYS.values()]);
export function defineDocumentFunction(functionConfig) {
    let { name, src, event, timeout, memory, env, type, ...maybeEvent } = functionConfig;
    if (!type)
        type = 'sanity.function.document';
    // event validation and normalization
    if (event) {
        // `event` was specified, but event keys (aggregated in `maybeEvent`) were also specified at the top level. ambiguous and deprecated usage.
        const duplicateKeys = Array.from(DOCUMENT_EVENT_KEYS).filter((key) => key in maybeEvent);
        if (duplicateKeys.length > 0) {
            throw new Error(`\`event\` properties should be specified under the \`event\` key - specifying them at the top level is deprecated. The following keys were specified at the top level: ${duplicateKeys.map((k) => `\`${k}\``).join(', ')}`);
        }
        event = buildDocumentFunctionEvent(event);
    }
    else {
        event = buildDocumentFunctionEvent(maybeEvent);
        // deprecated usage of putting event properties at the top level, warn about this.
        console.warn('⚠️ Deprecated usage of `defineDocumentFunction`: prefer to put `event` properties under the `event` key rather than at the top level.');
    }
    const functionResource = {
        ...defineFunction({
            name,
            src,
            timeout,
            memory,
            env,
        }, {
            skipValidation: true, // already done below
        }),
        type,
        event,
    };
    runValidation(() => validateDocumentFunction(functionResource));
    return functionResource;
}
export function defineMediaLibraryAssetFunction(functionConfig) {
    let { name, src, event, timeout, memory, env, type } = functionConfig;
    if (!type)
        type = 'sanity.function.media-library.asset';
    const functionResource = {
        ...defineFunction({
            name,
            src,
            timeout,
            memory,
            env,
        }, {
            skipValidation: true, // already done below
        }),
        type,
        event: buildMediaLibraryFunctionEvent(event),
    };
    runValidation(() => validateMediaLibraryAssetFunction(functionResource));
    return functionResource;
}
export function defineFunction(functionConfig, options) {
    let { name, src, timeout, memory, env, type } = functionConfig;
    // defaults
    if (!src)
        src = `functions/${name}`;
    if (!type)
        type = 'sanity.function.document';
    const functionResource = {
        type,
        name,
        src,
        timeout,
        memory,
        env,
    };
    if (options?.skipValidation !== true)
        runValidation(() => validateFunction(functionResource));
    return functionResource;
}
function buildDocumentFunctionEvent(event) {
    const cleanEvent = Object.fromEntries(Object.entries(event).filter(([key]) => DOCUMENT_EVENT_KEYS.has(key)));
    return {
        on: cleanEvent.on || ['publish'],
        ...cleanEvent,
    };
}
function buildMediaLibraryFunctionEvent(event) {
    const cleanEvent = Object.fromEntries(Object.entries(event).filter(([key]) => MEDIA_LIBRARY_EVENT_KEYS.has(key)));
    const fullEvent = {
        on: cleanEvent.on || ['publish'],
        ...cleanEvent,
    };
    return fullEvent;
}
//# sourceMappingURL=functions.js.map