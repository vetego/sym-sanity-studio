{"version":3,"sources":["../../src/util/getHashedBufferForUri.ts"],"sourcesContent":["import {createHash} from 'node:crypto'\nimport {finished} from 'node:stream/promises'\n\nimport {getIt} from 'get-it'\nimport {promise} from 'get-it/middleware'\nimport {getUri} from 'get-uri'\n\nimport type {GetItResponse} from '../types.js'\nimport {retryOnFailure} from './retryOnFailure.js'\nimport {isReadableStream} from './streamTypeGuards.js'\n\nconst request = getIt([promise()])\n\ninterface HashedBuffer {\n  buffer: Buffer\n  sha1hash: string\n}\n\nexport const getHashedBufferForUri = (uri: string): Promise<HashedBuffer> =>\n  retryOnFailure(() => getHashedBufferForUriInternal(uri))\n\nasync function getHashedBufferForUriInternal(uri: string): Promise<HashedBuffer> {\n  const stream = await getStream(uri)\n  const hash = createHash('sha1')\n  const chunks: Buffer[] = []\n\n  stream.on('data', (chunk: Buffer) => {\n    chunks.push(chunk)\n    hash.update(chunk)\n  })\n\n  await finished(stream)\n  return {\n    buffer: Buffer.concat(chunks),\n    sha1hash: hash.digest('hex'),\n  }\n}\n\nasync function getStream(uri: string): Promise<NodeJS.ReadableStream> {\n  const isHttp = /^https?:\\/\\//i.test(uri)\n  const parsed = new URL(uri)\n  if (isHttp) {\n    const res = (await request({url: parsed.href, stream: true})) as GetItResponse\n    return res.body\n  }\n\n  // For file, ftp, data urls\n  try {\n    const stream = await getUri(uri)\n    if (!isReadableStream(stream)) {\n      throw new Error(`Invalid stream type returned for URI: ${uri}`)\n    }\n    return stream\n  } catch (err) {\n    throw new Error(readError(uri, err as Error))\n  }\n}\n\nfunction readError(uri: string, err: Error): string {\n  return `Error while fetching asset from \"${uri}\":\\n${err.message}`\n}\n"],"names":["createHash","finished","getIt","promise","getUri","retryOnFailure","isReadableStream","request","getHashedBufferForUri","uri","getHashedBufferForUriInternal","stream","getStream","hash","chunks","on","chunk","push","update","buffer","Buffer","concat","sha1hash","digest","isHttp","test","parsed","URL","res","url","href","body","Error","err","readError","message"],"mappings":"AAAA,SAAQA,UAAU,QAAO,cAAa;AACtC,SAAQC,QAAQ,QAAO,uBAAsB;AAE7C,SAAQC,KAAK,QAAO,SAAQ;AAC5B,SAAQC,OAAO,QAAO,oBAAmB;AACzC,SAAQC,MAAM,QAAO,UAAS;AAG9B,SAAQC,cAAc,QAAO,sBAAqB;AAClD,SAAQC,gBAAgB,QAAO,wBAAuB;AAEtD,MAAMC,UAAUL,MAAM;IAACC;CAAU;AAOjC,OAAO,MAAMK,wBAAwB,CAACC,MACpCJ,eAAe,IAAMK,8BAA8BD,MAAK;AAE1D,eAAeC,8BAA8BD,GAAW;IACtD,MAAME,SAAS,MAAMC,UAAUH;IAC/B,MAAMI,OAAOb,WAAW;IACxB,MAAMc,SAAmB,EAAE;IAE3BH,OAAOI,EAAE,CAAC,QAAQ,CAACC;QACjBF,OAAOG,IAAI,CAACD;QACZH,KAAKK,MAAM,CAACF;IACd;IAEA,MAAMf,SAASU;IACf,OAAO;QACLQ,QAAQC,OAAOC,MAAM,CAACP;QACtBQ,UAAUT,KAAKU,MAAM,CAAC;IACxB;AACF;AAEA,eAAeX,UAAUH,GAAW;IAClC,MAAMe,SAAS,gBAAgBC,IAAI,CAAChB;IACpC,MAAMiB,SAAS,IAAIC,IAAIlB;IACvB,IAAIe,QAAQ;QACV,MAAMI,MAAO,MAAMrB,QAAQ;YAACsB,KAAKH,OAAOI,IAAI;YAAEnB,QAAQ;QAAI;QAC1D,OAAOiB,IAAIG,IAAI;IACjB;IAEA,2BAA2B;IAC3B,IAAI;QACF,MAAMpB,SAAS,MAAMP,OAAOK;QAC5B,IAAI,CAACH,iBAAiBK,SAAS;YAC7B,MAAM,IAAIqB,MAAM,CAAC,sCAAsC,EAAEvB,KAAK;QAChE;QACA,OAAOE;IACT,EAAE,OAAOsB,KAAK;QACZ,MAAM,IAAID,MAAME,UAAUzB,KAAKwB;IACjC;AACF;AAEA,SAASC,UAAUzB,GAAW,EAAEwB,GAAU;IACxC,OAAO,CAAC,iCAAiC,EAAExB,IAAI,IAAI,EAAEwB,IAAIE,OAAO,EAAE;AACpE"}