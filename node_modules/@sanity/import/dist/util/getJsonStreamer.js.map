{"version":3,"sources":["../../src/util/getJsonStreamer.ts"],"sourcesContent":["import split from 'split2'\n\nimport {validateDocument} from '../documentHasErrors.js'\nimport type {SanityDocument} from '../types.js'\n\nexport function getJsonStreamer(): NodeJS.ReadWriteStream {\n  let lineNumber = 0\n\n  const getErrorMessage = (err: Error): string => {\n    const suffix =\n      lineNumber === 1 ? '\\n\\nMake sure this is valid ndjson (one JSON-document *per line*)' : ''\n\n    return `Failed to parse line #${lineNumber}: ${err.message}${suffix}`\n  }\n\n  return split(parseRow)\n\n  function parseRow(this: NodeJS.ReadWriteStream, row: string) {\n    lineNumber++\n\n    if (!row) {\n      return undefined\n    }\n\n    try {\n      const doc = JSON.parse(row) as SanityDocument\n      const error = validateDocument(doc)\n      if (error) {\n        throw new Error(error)\n      }\n\n      return doc\n    } catch (err) {\n      const errorMessage = getErrorMessage(err as Error)\n      this.emit('error', new Error(errorMessage))\n    }\n\n    return undefined\n  }\n}\n"],"names":["split","validateDocument","getJsonStreamer","lineNumber","getErrorMessage","err","suffix","message","parseRow","row","undefined","doc","JSON","parse","error","Error","errorMessage","emit"],"mappings":"AAAA,OAAOA,WAAW,SAAQ;AAE1B,SAAQC,gBAAgB,QAAO,0BAAyB;AAGxD,OAAO,SAASC;IACd,IAAIC,aAAa;IAEjB,MAAMC,kBAAkB,CAACC;QACvB,MAAMC,SACJH,eAAe,IAAI,sEAAsE;QAE3F,OAAO,CAAC,sBAAsB,EAAEA,WAAW,EAAE,EAAEE,IAAIE,OAAO,GAAGD,QAAQ;IACvE;IAEA,OAAON,MAAMQ;IAEb,SAASA,SAAuCC,GAAW;QACzDN;QAEA,IAAI,CAACM,KAAK;YACR,OAAOC;QACT;QAEA,IAAI;YACF,MAAMC,MAAMC,KAAKC,KAAK,CAACJ;YACvB,MAAMK,QAAQb,iBAAiBU;YAC/B,IAAIG,OAAO;gBACT,MAAM,IAAIC,MAAMD;YAClB;YAEA,OAAOH;QACT,EAAE,OAAON,KAAK;YACZ,MAAMW,eAAeZ,gBAAgBC;YACrC,IAAI,CAACY,IAAI,CAAC,SAAS,IAAIF,MAAMC;QAC/B;QAEA,OAAON;IACT;AACF"}