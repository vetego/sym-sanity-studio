{"version":3,"sources":["../../src/util/retryOnFailure.ts"],"sourcesContent":[" \nimport debug from 'debug'\nimport {defaults} from 'lodash-es'\n\nconst log = debug('sanity:import')\n\ninterface RetryOptions {\n  delay?: number\n  maxTries?: number\n  isRetriable?: (error: Error) => boolean\n}\n\nexport async function retryOnFailure<T>(op: () => Promise<T>, opts: RetryOptions = {}): Promise<T> {\n  const options = defaults({}, opts, {delay: 150, maxTries: 3, isRetriable: () => true})\n\n  for (let attempt = 1; attempt <= options.maxTries; attempt++) {\n    try {\n      return await op()\n    } catch (err) {\n      const error = err as Error\n      if (!options.isRetriable(error)) {\n        log('Encountered error which is not retriable, giving up')\n        throw error\n      }\n\n      if (attempt === options.maxTries) {\n        log('Error encountered, max retries hit - giving up (attempt #%d)', attempt)\n        throw error\n      } else {\n        const ms = options.delay * attempt\n        log('Error encountered, waiting %d ms before retrying (attempt #%d)', ms, attempt)\n        log('Error details: %s', error.message)\n        await delay(ms)\n      }\n    }\n  }\n\n  // This should never be reached, but TypeScript requires a return\n  throw new Error('Unexpected end of retry loop')\n}\n\nfunction delay(ms: number): Promise<void> {\n  return new Promise((resolve) => setTimeout(resolve, ms))\n}\n"],"names":["debug","defaults","log","retryOnFailure","op","opts","options","delay","maxTries","isRetriable","attempt","err","error","ms","message","Error","Promise","resolve","setTimeout"],"mappings":"AACA,OAAOA,WAAW,QAAO;AACzB,SAAQC,QAAQ,QAAO,YAAW;AAElC,MAAMC,MAAMF,MAAM;AAQlB,OAAO,eAAeG,eAAkBC,EAAoB,EAAEC,OAAqB,CAAC,CAAC;IACnF,MAAMC,UAAUL,SAAS,CAAC,GAAGI,MAAM;QAACE,OAAO;QAAKC,UAAU;QAAGC,aAAa,IAAM;IAAI;IAEpF,IAAK,IAAIC,UAAU,GAAGA,WAAWJ,QAAQE,QAAQ,EAAEE,UAAW;QAC5D,IAAI;YACF,OAAO,MAAMN;QACf,EAAE,OAAOO,KAAK;YACZ,MAAMC,QAAQD;YACd,IAAI,CAACL,QAAQG,WAAW,CAACG,QAAQ;gBAC/BV,IAAI;gBACJ,MAAMU;YACR;YAEA,IAAIF,YAAYJ,QAAQE,QAAQ,EAAE;gBAChCN,IAAI,gEAAgEQ;gBACpE,MAAME;YACR,OAAO;gBACL,MAAMC,KAAKP,QAAQC,KAAK,GAAGG;gBAC3BR,IAAI,kEAAkEW,IAAIH;gBAC1ER,IAAI,qBAAqBU,MAAME,OAAO;gBACtC,MAAMP,MAAMM;YACd;QACF;IACF;IAEA,iEAAiE;IACjE,MAAM,IAAIE,MAAM;AAClB;AAEA,SAASR,MAAMM,EAAU;IACvB,OAAO,IAAIG,QAAQ,CAACC,UAAYC,WAAWD,SAASJ;AACtD"}