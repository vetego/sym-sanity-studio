{"version":3,"sources":["../src/batchDocuments.ts"],"sourcesContent":["import type {SanityDocument} from './types.js'\n\nconst MAX_PAYLOAD_SIZE = 1024 * 256 // 256KB\n\nfunction batchDocuments(docs: SanityDocument[]): SanityDocument[][] {\n  let currentBatch: SanityDocument[] = []\n  let currentBatchSize = 0\n  const batches: Array<SanityDocument[]> = [currentBatch]\n\n  docs.forEach((doc) => {\n    const docSize = JSON.stringify(doc).length\n    const newBatchSize = currentBatchSize + docSize\n\n    // If this document pushes us over the max payload size, start a new batch\n    if (currentBatchSize > 0 && newBatchSize > MAX_PAYLOAD_SIZE) {\n      currentBatch = [doc]\n      currentBatchSize = docSize\n      batches.push(currentBatch)\n      return\n    }\n\n    // If this document *alone* is over the max payload size, try to allow it\n    // on it's own. Server has slightly higher payload size than defined here\n    if (docSize > MAX_PAYLOAD_SIZE) {\n      if (currentBatchSize === 0) {\n        // We're alone in a new batch, so push this doc into it and start a new\n        // one for the next document in line\n        currentBatch.push(doc)\n        currentBatchSize = docSize\n        currentBatch = []\n        batches.push(currentBatch)\n        return\n      }\n\n      // Batch already has documents, so \"close\" that batch off and push this\n      // huge document into it's own batch\n      currentBatch = []\n      currentBatchSize = 0\n      batches.push([doc], currentBatch)\n    }\n\n    // Otherwise, we should be below the max size, so push this document into\n    // the batch and increase the size of it to match\n    currentBatch.push(doc)\n    currentBatchSize += docSize\n  })\n\n  return batches\n}\n\nexport {batchDocuments}\n"],"names":["MAX_PAYLOAD_SIZE","batchDocuments","docs","currentBatch","currentBatchSize","batches","forEach","doc","docSize","JSON","stringify","length","newBatchSize","push"],"mappings":"AAEA,MAAMA,mBAAmB,OAAO,IAAI,QAAQ;;AAE5C,SAASC,eAAeC,IAAsB;IAC5C,IAAIC,eAAiC,EAAE;IACvC,IAAIC,mBAAmB;IACvB,MAAMC,UAAmC;QAACF;KAAa;IAEvDD,KAAKI,OAAO,CAAC,CAACC;QACZ,MAAMC,UAAUC,KAAKC,SAAS,CAACH,KAAKI,MAAM;QAC1C,MAAMC,eAAeR,mBAAmBI;QAExC,0EAA0E;QAC1E,IAAIJ,mBAAmB,KAAKQ,eAAeZ,kBAAkB;YAC3DG,eAAe;gBAACI;aAAI;YACpBH,mBAAmBI;YACnBH,QAAQQ,IAAI,CAACV;YACb;QACF;QAEA,yEAAyE;QACzE,yEAAyE;QACzE,IAAIK,UAAUR,kBAAkB;YAC9B,IAAII,qBAAqB,GAAG;gBAC1B,uEAAuE;gBACvE,oCAAoC;gBACpCD,aAAaU,IAAI,CAACN;gBAClBH,mBAAmBI;gBACnBL,eAAe,EAAE;gBACjBE,QAAQQ,IAAI,CAACV;gBACb;YACF;YAEA,uEAAuE;YACvE,oCAAoC;YACpCA,eAAe,EAAE;YACjBC,mBAAmB;YACnBC,QAAQQ,IAAI,CAAC;gBAACN;aAAI,EAAEJ;QACtB;QAEA,yEAAyE;QACzE,iDAAiD;QACjDA,aAAaU,IAAI,CAACN;QAClBH,oBAAoBI;IACtB;IAEA,OAAOH;AACT;AAEA,SAAQJ,cAAc,GAAC"}