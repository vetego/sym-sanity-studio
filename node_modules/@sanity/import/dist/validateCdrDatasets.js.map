{"version":3,"sources":["../src/validateCdrDatasets.ts"],"sourcesContent":["import {extractWithPath} from '@sanity/mutator'\nimport {get} from 'lodash-es'\n\nimport type {CrossDatasetReference, ImportOptions, SanityDocument} from './types.js'\n\nexport async function validateCdrDatasets(\n  docs: SanityDocument[],\n  options: ImportOptions,\n): Promise<void> {\n  const datasets = getDatasetsFromCrossDatasetReferences(docs)\n  if (datasets.length === 0) {\n    return\n  }\n\n  const {client} = options\n  const existing = (await client.datasets.list()).map((dataset) => dataset.name)\n  const missing = datasets.filter((dataset) => !existing.includes(dataset))\n\n  if (missing.length > 1) {\n    throw new Error(\n      [\n        `The data to be imported contains one or more cross-dataset references, which refers to datasets that do not exist in the target project.`,\n        `Missing datasets: ${missing.map((ds) => `\"${ds}\"`).join(', ')}`,\n        'Either create these datasets in the given project, or use the `skipCrossDatasetReferences` option to skip these references.',\n      ].join('\\n'),\n    )\n  }\n\n  if (missing.length === 1) {\n    throw new Error(\n      [\n        `The data to be imported contains one or more cross-dataset references, which refers to a dataset that do not exist in the target project.`,\n        `Missing dataset: \"${missing[0]}\"`,\n        'Either create this dataset in the given project, or use the `skipCrossDatasetReferences` option to skip these references.',\n      ].join('\\n'),\n    )\n  }\n}\n\nfunction getDatasetsFromCrossDatasetReferences(docs: SanityDocument[]): string[] {\n  const datasets = new Set<string>()\n  for (const doc of docs) {\n    findCrossCdr(doc, datasets)\n  }\n\n  return Array.from(datasets)\n}\n\nfunction findCrossCdr(doc: SanityDocument, set: Set<string>): Set<string> {\n  return extractWithPath('..[_ref]', doc)\n    .map((match) => get(doc, match.path.slice(0, -1)) as CrossDatasetReference | undefined)\n    .filter((ref): ref is CrossDatasetReference => typeof ref?._dataset === 'string')\n    .reduce((datasets, ref) => datasets.add(ref._dataset), set)\n}\n"],"names":["extractWithPath","get","validateCdrDatasets","docs","options","datasets","getDatasetsFromCrossDatasetReferences","length","client","existing","list","map","dataset","name","missing","filter","includes","Error","ds","join","Set","doc","findCrossCdr","Array","from","set","match","path","slice","ref","_dataset","reduce","add"],"mappings":"AAAA,SAAQA,eAAe,QAAO,kBAAiB;AAC/C,SAAQC,GAAG,QAAO,YAAW;AAI7B,OAAO,eAAeC,oBACpBC,IAAsB,EACtBC,OAAsB;IAEtB,MAAMC,WAAWC,sCAAsCH;IACvD,IAAIE,SAASE,MAAM,KAAK,GAAG;QACzB;IACF;IAEA,MAAM,EAACC,MAAM,EAAC,GAAGJ;IACjB,MAAMK,WAAW,AAAC,CAAA,MAAMD,OAAOH,QAAQ,CAACK,IAAI,EAAC,EAAGC,GAAG,CAAC,CAACC,UAAYA,QAAQC,IAAI;IAC7E,MAAMC,UAAUT,SAASU,MAAM,CAAC,CAACH,UAAY,CAACH,SAASO,QAAQ,CAACJ;IAEhE,IAAIE,QAAQP,MAAM,GAAG,GAAG;QACtB,MAAM,IAAIU,MACR;YACE,CAAC,wIAAwI,CAAC;YAC1I,CAAC,kBAAkB,EAAEH,QAAQH,GAAG,CAAC,CAACO,KAAO,CAAC,CAAC,EAAEA,GAAG,CAAC,CAAC,EAAEC,IAAI,CAAC,OAAO;YAChE;SACD,CAACA,IAAI,CAAC;IAEX;IAEA,IAAIL,QAAQP,MAAM,KAAK,GAAG;QACxB,MAAM,IAAIU,MACR;YACE,CAAC,yIAAyI,CAAC;YAC3I,CAAC,kBAAkB,EAAEH,OAAO,CAAC,EAAE,CAAC,CAAC,CAAC;YAClC;SACD,CAACK,IAAI,CAAC;IAEX;AACF;AAEA,SAASb,sCAAsCH,IAAsB;IACnE,MAAME,WAAW,IAAIe;IACrB,KAAK,MAAMC,OAAOlB,KAAM;QACtBmB,aAAaD,KAAKhB;IACpB;IAEA,OAAOkB,MAAMC,IAAI,CAACnB;AACpB;AAEA,SAASiB,aAAaD,GAAmB,EAAEI,GAAgB;IACzD,OAAOzB,gBAAgB,YAAYqB,KAChCV,GAAG,CAAC,CAACe,QAAUzB,IAAIoB,KAAKK,MAAMC,IAAI,CAACC,KAAK,CAAC,GAAG,CAAC,KAC7Cb,MAAM,CAAC,CAACc,MAAsC,OAAOA,KAAKC,aAAa,UACvEC,MAAM,CAAC,CAAC1B,UAAUwB,MAAQxB,SAAS2B,GAAG,CAACH,IAAIC,QAAQ,GAAGL;AAC3D"}