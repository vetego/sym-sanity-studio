{"version":3,"sources":["../src/assetRefs.ts"],"sourcesContent":["import {pathToFileURL} from 'node:url'\n\nimport {extractWithPath} from '@sanity/mutator'\nimport {get, set, unset} from 'lodash-es'\n\nimport {serializePath} from './serializePath.js'\nimport type {SanityDocument} from './types.js'\n\nconst assetKey = '_sanityAsset'\nconst assetMatcher = /^(file|image)@([a-z]+:\\/\\/.*)/\n\nexport interface AssetRef {\n  documentId: string\n  path: string\n  url: string\n  type: string\n}\n\n// Note: mutates in-place\nexport function unsetAssetRefs(doc: SanityDocument): SanityDocument {\n  findAssetRefs(doc).forEach((path) => {\n    const parentPath = path.slice(0, -1)\n    const parent = get(doc, parentPath) as Record<string, unknown>\n\n    // If the only key in the object is `_sanityAsset`, unset the whole thing,\n    // as we will be using a `setIfMissing({[path]: {}})` patch to enforce it.\n    // Prevents empty objects from appearing while import is running\n    const isOnlyKey = parent && Object.keys(parent).length === 1 && parent[assetKey]\n    const unsetPath = isOnlyKey ? parentPath : path\n\n    unset(doc, unsetPath)\n  })\n\n  return doc\n}\n\n// Note: mutates in-place\nexport function absolutifyPaths(doc: SanityDocument, absPath?: string): SanityDocument {\n  if (!absPath) {\n    return doc\n  }\n\n  const modifier = (value: string): string =>\n    value\n      .replace(/file:\\/\\/\\.\\//i, `${pathToFileURL(absPath).href}/`)\n      .replace(/(https?):\\/\\/\\.\\//, `$1://${absPath}/`)\n\n  findAssetRefs(doc).forEach((path) => {\n    const value = get(doc, path) as string\n    set(doc, path, modifier(value))\n  })\n\n  return doc\n}\n\nexport function getAssetRefs(doc: SanityDocument): AssetRef[] {\n  return findAssetRefs(doc)\n    .map((path) => validateAssetImportKey(path, doc))\n    .map((path) => {\n      const value = get(doc, path) as string\n      return {\n        documentId: doc._id,\n        path: serializePath({path: path.filter(isNotAssetKey)}),\n        url: value.replace(assetMatcher, '$2'),\n        type: value.replace(assetMatcher, '$1'),\n      }\n    })\n}\n\nfunction isNotAssetKey(segment: string | number): boolean {\n  return segment !== assetKey\n}\n\nfunction findAssetRefs(doc: SanityDocument): (string | number)[][] {\n  return extractWithPath(`..[${assetKey}]`, doc).map((match) => match.path)\n}\n\nexport function validateAssetImportKey(\n  path: (string | number)[],\n  doc: SanityDocument,\n): (string | number)[] {\n  if (!assetMatcher.test(get(doc, path) as string)) {\n    throw new Error(\n      [\n        'Asset type is not specified.',\n        '`_sanityAsset` values must be prefixed with a type, eg image@url or file@url.',\n        `See document with ID \"${doc._id}\", path: ${serializePath({path})}`,\n      ].join('\\n'),\n    )\n  }\n\n  return path\n}\n"],"names":["pathToFileURL","extractWithPath","get","set","unset","serializePath","assetKey","assetMatcher","unsetAssetRefs","doc","findAssetRefs","forEach","path","parentPath","slice","parent","isOnlyKey","Object","keys","length","unsetPath","absolutifyPaths","absPath","modifier","value","replace","href","getAssetRefs","map","validateAssetImportKey","documentId","_id","filter","isNotAssetKey","url","type","segment","match","test","Error","join"],"mappings":"AAAA,SAAQA,aAAa,QAAO,WAAU;AAEtC,SAAQC,eAAe,QAAO,kBAAiB;AAC/C,SAAQC,GAAG,EAAEC,GAAG,EAAEC,KAAK,QAAO,YAAW;AAEzC,SAAQC,aAAa,QAAO,qBAAoB;AAGhD,MAAMC,WAAW;AACjB,MAAMC,eAAe;AASrB,yBAAyB;AACzB,OAAO,SAASC,eAAeC,GAAmB;IAChDC,cAAcD,KAAKE,OAAO,CAAC,CAACC;QAC1B,MAAMC,aAAaD,KAAKE,KAAK,CAAC,GAAG,CAAC;QAClC,MAAMC,SAASb,IAAIO,KAAKI;QAExB,0EAA0E;QAC1E,0EAA0E;QAC1E,gEAAgE;QAChE,MAAMG,YAAYD,UAAUE,OAAOC,IAAI,CAACH,QAAQI,MAAM,KAAK,KAAKJ,MAAM,CAACT,SAAS;QAChF,MAAMc,YAAYJ,YAAYH,aAAaD;QAE3CR,MAAMK,KAAKW;IACb;IAEA,OAAOX;AACT;AAEA,yBAAyB;AACzB,OAAO,SAASY,gBAAgBZ,GAAmB,EAAEa,OAAgB;IACnE,IAAI,CAACA,SAAS;QACZ,OAAOb;IACT;IAEA,MAAMc,WAAW,CAACC,QAChBA,MACGC,OAAO,CAAC,kBAAkB,GAAGzB,cAAcsB,SAASI,IAAI,CAAC,CAAC,CAAC,EAC3DD,OAAO,CAAC,qBAAqB,CAAC,KAAK,EAAEH,QAAQ,CAAC,CAAC;IAEpDZ,cAAcD,KAAKE,OAAO,CAAC,CAACC;QAC1B,MAAMY,QAAQtB,IAAIO,KAAKG;QACvBT,IAAIM,KAAKG,MAAMW,SAASC;IAC1B;IAEA,OAAOf;AACT;AAEA,OAAO,SAASkB,aAAalB,GAAmB;IAC9C,OAAOC,cAAcD,KAClBmB,GAAG,CAAC,CAAChB,OAASiB,uBAAuBjB,MAAMH,MAC3CmB,GAAG,CAAC,CAAChB;QACJ,MAAMY,QAAQtB,IAAIO,KAAKG;QACvB,OAAO;YACLkB,YAAYrB,IAAIsB,GAAG;YACnBnB,MAAMP,cAAc;gBAACO,MAAMA,KAAKoB,MAAM,CAACC;YAAc;YACrDC,KAAKV,MAAMC,OAAO,CAAClB,cAAc;YACjC4B,MAAMX,MAAMC,OAAO,CAAClB,cAAc;QACpC;IACF;AACJ;AAEA,SAAS0B,cAAcG,OAAwB;IAC7C,OAAOA,YAAY9B;AACrB;AAEA,SAASI,cAAcD,GAAmB;IACxC,OAAOR,gBAAgB,CAAC,GAAG,EAAEK,SAAS,CAAC,CAAC,EAAEG,KAAKmB,GAAG,CAAC,CAACS,QAAUA,MAAMzB,IAAI;AAC1E;AAEA,OAAO,SAASiB,uBACdjB,IAAyB,EACzBH,GAAmB;IAEnB,IAAI,CAACF,aAAa+B,IAAI,CAACpC,IAAIO,KAAKG,QAAkB;QAChD,MAAM,IAAI2B,MACR;YACE;YACA;YACA,CAAC,sBAAsB,EAAE9B,IAAIsB,GAAG,CAAC,SAAS,EAAE1B,cAAc;gBAACO;YAAI,IAAI;SACpE,CAAC4B,IAAI,CAAC;IAEX;IAEA,OAAO5B;AACT"}