{"version":3,"sources":["../src/validateOptions.ts"],"sourcesContent":["import fs from 'node:fs'\n\nimport {defaults, noop} from 'lodash-es'\n\nimport type {ImportOptions, ImportSource} from './types.js'\n\nconst clientMethods = ['fetch', 'transaction', 'config'] as const\nconst allowedOperations = ['create', 'createIfNotExists', 'createOrReplace'] as const\nconst allowedReleasesOperations = ['fail', 'ignore', 'replace'] as const\nconst defaultOperation = allowedOperations[0]\nconst defaultReleasesOperation = allowedReleasesOperations[0]\n\nexport function validateOptions(input: ImportSource, opts: Partial<ImportOptions>): ImportOptions {\n  const options = defaults({}, opts, {\n    tag: 'sanity.import',\n    operation: defaultOperation,\n    onProgress: noop,\n    allowAssetsInDifferentDataset: false,\n    replaceAssets: false,\n    skipCrossDatasetReferences: false,\n    allowSystemDocuments: false,\n    releasesOperation: defaultReleasesOperation,\n  })\n\n  if (!isValidInput(input)) {\n    throw new Error(\n      'Input does not seem to be a readable stream, an array or a path to a directory',\n    )\n  }\n\n  if (!options.client) {\n    throw new Error('`options.client` must be set to an instance of @sanity/client')\n  }\n\n  const missing = clientMethods.find((key) => typeof options.client?.[key] !== 'function')\n\n  if (missing) {\n    throw new Error(\n      `\\`options.client\\` is not a valid @sanity/client instance - no \"${missing}\" method found`,\n    )\n  }\n\n  const clientConfig = options.client.config()\n  if (!clientConfig.token) {\n    throw new Error('Client is not instantiated with a `token`')\n  }\n\n  // We don't want `sanity.cli.sanity.import`, so if this is coming from the CLI, unset the prefix\n  if (clientConfig.requestTagPrefix === 'sanity.cli' && options.tag === 'sanity.import') {\n    const newConfig = {...clientConfig}\n    delete newConfig.requestTagPrefix\n    options.client = options.client.withConfig(newConfig)\n  }\n\n  if (!allowedOperations.includes(options.operation)) {\n    throw new Error(`Operation \"${options.operation}\" is not supported`)\n  }\n\n  if (!allowedReleasesOperations.includes(options.releasesOperation)) {\n    throw new Error(`Releases operation \"${options.releasesOperation}\" is not supported`)\n  }\n\n  if (options.assetConcurrency && options.assetConcurrency > 12) {\n    throw new Error('`assetConcurrency` must be <= 12')\n  }\n\n  if (typeof options.tag !== 'string' || !/^[a-z0-9._-]{1,75}$/i.test(options.tag)) {\n    throw new Error(\n      `Tag can only contain alphanumeric characters, underscores, dashes and dots, and be between one and 75 characters long.`,\n    )\n  }\n\n  if (clientConfig.projectId) {\n    options.targetProjectId = clientConfig.projectId\n  }\n  if (clientConfig.dataset) {\n    options.targetDataset = clientConfig.dataset\n  }\n\n  return options as ImportOptions\n}\n\nfunction isValidInput(input: ImportSource): boolean {\n  if (!input) {\n    return false\n  }\n\n  if (\n    typeof input === 'object' &&\n    input !== null &&\n    'pipe' in input &&\n    typeof input.pipe === 'function'\n  ) {\n    return true\n  }\n\n  if (Array.isArray(input)) {\n    return true\n  }\n\n  if (typeof input === 'string' && isDirectory(input)) {\n    return true\n  }\n\n  return false\n}\n\nfunction isDirectory(path: string): boolean {\n  try {\n    const stats = fs.statSync(path)\n    return stats.isDirectory()\n  } catch {\n    return false\n  }\n}\n"],"names":["fs","defaults","noop","clientMethods","allowedOperations","allowedReleasesOperations","defaultOperation","defaultReleasesOperation","validateOptions","input","opts","options","tag","operation","onProgress","allowAssetsInDifferentDataset","replaceAssets","skipCrossDatasetReferences","allowSystemDocuments","releasesOperation","isValidInput","Error","client","missing","find","key","clientConfig","config","token","requestTagPrefix","newConfig","withConfig","includes","assetConcurrency","test","projectId","targetProjectId","dataset","targetDataset","pipe","Array","isArray","isDirectory","path","stats","statSync"],"mappings":"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"}