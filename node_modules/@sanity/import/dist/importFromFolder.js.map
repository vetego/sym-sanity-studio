{"version":3,"sources":["../src/importFromFolder.ts"],"sourcesContent":["import fs from 'node:fs'\nimport {rm} from 'node:fs/promises'\nimport path from 'node:path'\nimport {pathToFileURL} from 'node:url'\n\nimport createDebug from 'debug'\nimport {glob} from 'tinyglobby'\n\nimport type {AssetMap, ImportersContext, ImportOptions, ImportResult} from './types.js'\nimport {readJson} from './util/readJson.js'\n\nconst debug = createDebug('sanity:import:folder')\n\nexport async function importFromFolder(\n  fromDir: string,\n  options: ImportOptions,\n  importers: ImportersContext,\n): Promise<ImportResult> {\n  debug('Importing from folder %s', fromDir)\n  const dataFiles = await glob(['*.ndjson'], {cwd: fromDir, absolute: true})\n  if (dataFiles.length === 0) {\n    throw new Error(`No .ndjson file found in ${fromDir}`)\n  }\n\n  if (dataFiles.length > 1) {\n    throw new Error(`More than one .ndjson file found in ${fromDir} - only one is supported`)\n  }\n\n  const assetMap = await readJson<AssetMap>(path.join(fromDir, 'assets.json')).catch(\n    () => ({}) as AssetMap,\n  )\n\n  const dataFile = dataFiles[0]\n  debug('Importing from file %s', dataFile)\n\n  const stream = fs.createReadStream(dataFile!)\n  const images = await glob('images/*', {cwd: fromDir, absolute: true})\n  const files = await glob('files/*', {cwd: fromDir, absolute: true})\n  const imageAssets = images.map((imgPath: string) => `image#${pathToFileURL(imgPath).href}`)\n  const fileAssets = files.map((filePath: string) => `file#${pathToFileURL(filePath).href}`)\n  const unreferencedAssets: string[] = [...imageAssets, ...fileAssets]\n\n  debug('Queueing %d assets', unreferencedAssets.length)\n\n  const streamOptions = {...options, unreferencedAssets, assetsBase: fromDir, assetMap}\n  const result = await importers.fromStream(stream, streamOptions, importers)\n\n  if (options.deleteOnComplete) {\n    await rm(fromDir, {recursive: true, force: true})\n  }\n\n  return result\n}\n"],"names":["fs","rm","path","pathToFileURL","createDebug","glob","readJson","debug","importFromFolder","fromDir","options","importers","dataFiles","cwd","absolute","length","Error","assetMap","join","catch","dataFile","stream","createReadStream","images","files","imageAssets","map","imgPath","href","fileAssets","filePath","unreferencedAssets","streamOptions","assetsBase","result","fromStream","deleteOnComplete","recursive","force"],"mappings":"AAAA,OAAOA,QAAQ,UAAS;AACxB,SAAQC,EAAE,QAAO,mBAAkB;AACnC,OAAOC,UAAU,YAAW;AAC5B,SAAQC,aAAa,QAAO,WAAU;AAEtC,OAAOC,iBAAiB,QAAO;AAC/B,SAAQC,IAAI,QAAO,aAAY;AAG/B,SAAQC,QAAQ,QAAO,qBAAoB;AAE3C,MAAMC,QAAQH,YAAY;AAE1B,OAAO,eAAeI,iBACpBC,OAAe,EACfC,OAAsB,EACtBC,SAA2B;IAE3BJ,MAAM,4BAA4BE;IAClC,MAAMG,YAAY,MAAMP,KAAK;QAAC;KAAW,EAAE;QAACQ,KAAKJ;QAASK,UAAU;IAAI;IACxE,IAAIF,UAAUG,MAAM,KAAK,GAAG;QAC1B,MAAM,IAAIC,MAAM,CAAC,yBAAyB,EAAEP,SAAS;IACvD;IAEA,IAAIG,UAAUG,MAAM,GAAG,GAAG;QACxB,MAAM,IAAIC,MAAM,CAAC,oCAAoC,EAAEP,QAAQ,wBAAwB,CAAC;IAC1F;IAEA,MAAMQ,WAAW,MAAMX,SAAmBJ,KAAKgB,IAAI,CAACT,SAAS,gBAAgBU,KAAK,CAChF,IAAO,CAAA,CAAC,CAAA;IAGV,MAAMC,WAAWR,SAAS,CAAC,EAAE;IAC7BL,MAAM,0BAA0Ba;IAEhC,MAAMC,SAASrB,GAAGsB,gBAAgB,CAACF;IACnC,MAAMG,SAAS,MAAMlB,KAAK,YAAY;QAACQ,KAAKJ;QAASK,UAAU;IAAI;IACnE,MAAMU,QAAQ,MAAMnB,KAAK,WAAW;QAACQ,KAAKJ;QAASK,UAAU;IAAI;IACjE,MAAMW,cAAcF,OAAOG,GAAG,CAAC,CAACC,UAAoB,CAAC,MAAM,EAAExB,cAAcwB,SAASC,IAAI,EAAE;IAC1F,MAAMC,aAAaL,MAAME,GAAG,CAAC,CAACI,WAAqB,CAAC,KAAK,EAAE3B,cAAc2B,UAAUF,IAAI,EAAE;IACzF,MAAMG,qBAA+B;WAAIN;WAAgBI;KAAW;IAEpEtB,MAAM,sBAAsBwB,mBAAmBhB,MAAM;IAErD,MAAMiB,gBAAgB;QAAC,GAAGtB,OAAO;QAAEqB;QAAoBE,YAAYxB;QAASQ;IAAQ;IACpF,MAAMiB,SAAS,MAAMvB,UAAUwB,UAAU,CAACd,QAAQW,eAAerB;IAEjE,IAAID,QAAQ0B,gBAAgB,EAAE;QAC5B,MAAMnC,GAAGQ,SAAS;YAAC4B,WAAW;YAAMC,OAAO;QAAI;IACjD;IAEA,OAAOJ;AACT"}