{"version":3,"sources":["../src/references.ts"],"sourcesContent":["import type {MultipleMutationResult, SanityClient, Transaction} from '@sanity/client'\nimport {extractWithPath} from '@sanity/mutator'\nimport debug from 'debug'\nimport {get} from 'lodash-es'\nimport pMap from 'p-map'\n\nimport {serializePath} from './serializePath.js'\nimport type {\n  ImportOptions,\n  Reference,\n  SanityApiError,\n  SanityDocument,\n  StreamReference,\n} from './types.js'\nimport {progressStepper} from './util/progressStepper.js'\nimport {retryOnFailure} from './util/retryOnFailure.js'\nimport {suffixTag} from './util/suffixTag.js'\n\nconst logger = debug('sanity:import')\n\nconst STRENGTHEN_CONCURRENCY = 30\nconst STRENGTHEN_BATCH_SIZE = 30\n\nexport interface StrongRefsTask {\n  documentId: string\n  references: string[]\n}\n\ninterface RefPathItem {\n  path: (string | number)[]\n  ref: StreamReference\n}\n\nexport function getStrongRefs(doc: SanityDocument): StrongRefsTask | null {\n  const refs = findStrongRefs(doc).map(serializePath)\n  if (refs.length) {\n    return {\n      documentId: doc._id,\n      references: refs,\n    }\n  }\n\n  return null\n}\n\n// Note: mutates in-place\nexport function weakenStrongRefs(doc: SanityDocument): SanityDocument {\n  const refs = findStrongRefs(doc)\n\n  refs.forEach((item) => {\n    item.ref._weak = true\n  })\n\n  return doc\n}\n\n// Note: mutates in-place\nexport function cleanupReferences(doc: SanityDocument, options: ImportOptions): SanityDocument {\n  const {targetProjectId, skipCrossDatasetReferences} = options\n  extractWithPath('..[_ref]', doc)\n    .map((match) => match.path.slice(0, -1))\n    .map((path) => ({path, ref: get(doc, path) as StreamReference}))\n    .forEach((item: RefPathItem) => {\n      // We may want to skip cross-dataset references, eg when importing to other projects\n      if (skipCrossDatasetReferences && '_dataset' in item.ref) {\n        const leaf = item.path[item.path.length - 1]\n        const parent =\n          item.path.length > 1\n            ? (get(doc, item.path.slice(0, -1)) as Record<string | number, unknown>)\n            : doc\n        if (typeof leaf === 'string' || typeof leaf === 'number') {\n          delete parent[leaf]\n        }\n        return\n      }\n\n      // Apply missing _type on references\n      if (typeof (item.ref as Reference)._type === 'undefined') {\n        ;(item.ref as Reference)._type = 'reference'\n      }\n\n      // Ensure cross-dataset references point to the same project ID as being imported to\n      const refWithProjectId = item.ref as StreamReference & {_projectId?: string}\n      if (typeof refWithProjectId._projectId !== 'undefined') {\n        refWithProjectId._projectId = targetProjectId!\n      }\n    })\n\n  return doc\n}\n\nfunction findStrongRefs(doc: SanityDocument): RefPathItem[] {\n  return extractWithPath('..[_ref]', doc)\n    .map((match) => match.path.slice(0, -1))\n    .map((path) => ({path, ref: get(doc, path) as StreamReference}))\n    .filter((item) => item.ref._weak !== true)\n}\n\nexport function strengthenReferences(\n  strongRefs: StrongRefsTask[],\n  options: ImportOptions,\n): Promise<number[]> {\n  const {client, tag} = options\n\n  const batches: StrongRefsTask[][] = []\n  for (let i = 0; i < strongRefs.length; i += STRENGTHEN_BATCH_SIZE) {\n    batches.push(strongRefs.slice(i, i + STRENGTHEN_BATCH_SIZE))\n  }\n\n  if (batches.length === 0) {\n    return Promise.resolve([0])\n  }\n\n  const progress = progressStepper(options.onProgress, {\n    step: 'Strengthening references',\n    total: batches.length,\n  })\n\n  const mapOptions = {concurrency: STRENGTHEN_CONCURRENCY}\n  return pMap(batches, unsetWeakBatch.bind(null, client, progress, tag), mapOptions)\n}\n\nfunction unsetWeakBatch(\n  client: SanityClient,\n  progress: () => void,\n  tag: string,\n  batch: StrongRefsTask[],\n): Promise<number> {\n  logger('Strengthening batch of %d documents', batch.length)\n  return retryOnFailure(\n    () =>\n      batch\n        .reduce(reducePatch, client.transaction())\n        .commit({visibility: 'async', tag: suffixTag(tag, 'ref.strengthen')})\n        .then((res: MultipleMutationResult) => {\n          progress()\n          return res.results.length\n        })\n        .catch((err: Error) => {\n          const apiError = err as SanityApiError & {step?: string}\n          apiError.step = 'strengthen-references'\n          throw apiError\n        }),\n    {isRetriable: (err: SanityApiError) => !err.statusCode || err.statusCode !== 409},\n  )\n}\n\nfunction reducePatch(trx: Transaction, task: StrongRefsTask): Transaction {\n  return trx.patch(task.documentId, (patch) =>\n    patch.unset(task.references.map((path) => `${path}._weak`)),\n  )\n}\n"],"names":["extractWithPath","debug","get","pMap","serializePath","progressStepper","retryOnFailure","suffixTag","logger","STRENGTHEN_CONCURRENCY","STRENGTHEN_BATCH_SIZE","getStrongRefs","doc","refs","findStrongRefs","map","length","documentId","_id","references","weakenStrongRefs","forEach","item","ref","_weak","cleanupReferences","options","targetProjectId","skipCrossDatasetReferences","match","path","slice","leaf","parent","_type","refWithProjectId","_projectId","filter","strengthenReferences","strongRefs","client","tag","batches","i","push","Promise","resolve","progress","onProgress","step","total","mapOptions","concurrency","unsetWeakBatch","bind","batch","reduce","reducePatch","transaction","commit","visibility","then","res","results","catch","err","apiError","isRetriable","statusCode","trx","task","patch","unset"],"mappings":"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"}