{"version":3,"sources":["../src/importBatches.ts"],"sourcesContent":["import type {ImportReleaseAction, MultipleMutationResult, Transaction} from '@sanity/client'\nimport {partition} from 'lodash-es'\nimport pMap from 'p-map'\n\nimport type {ImportOptions, SanityApiError, SanityDocument} from './types.js'\nimport {progressStepper} from './util/progressStepper.js'\nimport {retryOnFailure} from './util/retryOnFailure.js'\nimport {suffixTag} from './util/suffixTag.js'\n\nconst DOCUMENT_IMPORT_CONCURRENCY = 6\n\nexport async function importBatches(\n  batches: SanityDocument[][],\n  options: ImportOptions,\n): Promise<number> {\n  const progress = progressStepper(options.onProgress, {\n    step: 'Importing documents',\n    total: batches.length,\n  })\n\n  const mapOptions = {concurrency: DOCUMENT_IMPORT_CONCURRENCY}\n  const batchSizes = await pMap(batches, importBatch.bind(null, options, progress), mapOptions)\n\n  return batchSizes.reduce((prev, add) => prev + add, 0)\n}\n\nfunction importBatch(\n  options: ImportOptions,\n  progress: () => void,\n  batch: SanityDocument[],\n): Promise<number> {\n  const {client, operation, releasesOperation, tag} = options\n  const maxRetries = operation === 'create' ? 1 : 3\n\n  return retryOnFailure(\n    () => {\n      const [releaseDocs, docs] = partition(batch, (doc) => doc._id.startsWith('_.releases.'))\n\n      const docsTransaction =\n        docs.length > 0\n          ? docs\n              .reduce((trx: Transaction, doc) => {\n                if (operation === 'create') return trx.create(doc)\n                if (operation === 'createIfNotExists') return trx.createIfNotExists(doc)\n                if (operation === 'createOrReplace') return trx.createOrReplace(doc)\n                throw new Error(`Unknown operation: ${operation as string}`)\n              }, client.transaction())\n              .commit({visibility: 'async', tag: suffixTag(tag, 'doc.create')})\n              .then((res: MultipleMutationResult) => {\n                progress()\n                return res.results.length\n              })\n          : Promise.resolve(0)\n\n      const releasesAction = releaseDocs.map((doc: SanityDocument) => {\n        const actionParams: ImportReleaseAction = {\n          actionType: 'sanity.action.release.import',\n          releaseId: doc.name as string,\n          attributes: doc,\n          ifExists: releasesOperation,\n        }\n        return client\n          .action(actionParams)\n          .then(() => 1)\n          .catch((err: Error) => {\n            err.message = `Release import failed for ${doc._id}: ${err.message}`\n            throw err\n          })\n      })\n\n      return Promise.all([docsTransaction, ...releasesAction]).then((results) => {\n        const totalCount = results.reduce((sum: number, count: number) => sum + count, 0)\n        return totalCount\n      })\n    },\n    {maxTries: maxRetries, isRetriable},\n  )\n}\n\nfunction isRetriable(err: SanityApiError): boolean {\n  return !err.response || err.response.statusCode !== 409\n}\n"],"names":["partition","pMap","progressStepper","retryOnFailure","suffixTag","DOCUMENT_IMPORT_CONCURRENCY","importBatches","batches","options","progress","onProgress","step","total","length","mapOptions","concurrency","batchSizes","importBatch","bind","reduce","prev","add","batch","client","operation","releasesOperation","tag","maxRetries","releaseDocs","docs","doc","_id","startsWith","docsTransaction","trx","create","createIfNotExists","createOrReplace","Error","transaction","commit","visibility","then","res","results","Promise","resolve","releasesAction","map","actionParams","actionType","releaseId","name","attributes","ifExists","action","catch","err","message","all","totalCount","sum","count","maxTries","isRetriable","response","statusCode"],"mappings":"AACA,SAAQA,SAAS,QAAO,YAAW;AACnC,OAAOC,UAAU,QAAO;AAGxB,SAAQC,eAAe,QAAO,4BAA2B;AACzD,SAAQC,cAAc,QAAO,2BAA0B;AACvD,SAAQC,SAAS,QAAO,sBAAqB;AAE7C,MAAMC,8BAA8B;AAEpC,OAAO,eAAeC,cACpBC,OAA2B,EAC3BC,OAAsB;IAEtB,MAAMC,WAAWP,gBAAgBM,QAAQE,UAAU,EAAE;QACnDC,MAAM;QACNC,OAAOL,QAAQM,MAAM;IACvB;IAEA,MAAMC,aAAa;QAACC,aAAaV;IAA2B;IAC5D,MAAMW,aAAa,MAAMf,KAAKM,SAASU,YAAYC,IAAI,CAAC,MAAMV,SAASC,WAAWK;IAElF,OAAOE,WAAWG,MAAM,CAAC,CAACC,MAAMC,MAAQD,OAAOC,KAAK;AACtD;AAEA,SAASJ,YACPT,OAAsB,EACtBC,QAAoB,EACpBa,KAAuB;IAEvB,MAAM,EAACC,MAAM,EAAEC,SAAS,EAAEC,iBAAiB,EAAEC,GAAG,EAAC,GAAGlB;IACpD,MAAMmB,aAAaH,cAAc,WAAW,IAAI;IAEhD,OAAOrB,eACL;QACE,MAAM,CAACyB,aAAaC,KAAK,GAAG7B,UAAUsB,OAAO,CAACQ,MAAQA,IAAIC,GAAG,CAACC,UAAU,CAAC;QAEzE,MAAMC,kBACJJ,KAAKhB,MAAM,GAAG,IACVgB,KACGV,MAAM,CAAC,CAACe,KAAkBJ;YACzB,IAAIN,cAAc,UAAU,OAAOU,IAAIC,MAAM,CAACL;YAC9C,IAAIN,cAAc,qBAAqB,OAAOU,IAAIE,iBAAiB,CAACN;YACpE,IAAIN,cAAc,mBAAmB,OAAOU,IAAIG,eAAe,CAACP;YAChE,MAAM,IAAIQ,MAAM,CAAC,mBAAmB,EAAEd,WAAqB;QAC7D,GAAGD,OAAOgB,WAAW,IACpBC,MAAM,CAAC;YAACC,YAAY;YAASf,KAAKtB,UAAUsB,KAAK;QAAa,GAC9DgB,IAAI,CAAC,CAACC;YACLlC;YACA,OAAOkC,IAAIC,OAAO,CAAC/B,MAAM;QAC3B,KACFgC,QAAQC,OAAO,CAAC;QAEtB,MAAMC,iBAAiBnB,YAAYoB,GAAG,CAAC,CAAClB;YACtC,MAAMmB,eAAoC;gBACxCC,YAAY;gBACZC,WAAWrB,IAAIsB,IAAI;gBACnBC,YAAYvB;gBACZwB,UAAU7B;YACZ;YACA,OAAOF,OACJgC,MAAM,CAACN,cACPP,IAAI,CAAC,IAAM,GACXc,KAAK,CAAC,CAACC;gBACNA,IAAIC,OAAO,GAAG,CAAC,0BAA0B,EAAE5B,IAAIC,GAAG,CAAC,EAAE,EAAE0B,IAAIC,OAAO,EAAE;gBACpE,MAAMD;YACR;QACJ;QAEA,OAAOZ,QAAQc,GAAG,CAAC;YAAC1B;eAAoBc;SAAe,EAAEL,IAAI,CAAC,CAACE;YAC7D,MAAMgB,aAAahB,QAAQzB,MAAM,CAAC,CAAC0C,KAAaC,QAAkBD,MAAMC,OAAO;YAC/E,OAAOF;QACT;IACF,GACA;QAACG,UAAUpC;QAAYqC;IAAW;AAEtC;AAEA,SAASA,YAAYP,GAAmB;IACtC,OAAO,CAACA,IAAIQ,QAAQ,IAAIR,IAAIQ,QAAQ,CAACC,UAAU,KAAK;AACtD"}