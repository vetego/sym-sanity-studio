{"version":3,"sources":["../src/validateAssetDocuments.ts"],"sourcesContent":["import {generateHelpUrl} from '@sanity/generate-help-url'\nimport debug from 'debug'\nimport pMap from 'p-map'\n\nimport type {AssetDocument, AssetMetadata, ImportOptions, SanityDocument} from './types.js'\nimport {urlExists} from './util/urlExists.js'\n\nconst logger = debug('sanity:import:asset-validation')\n\nconst DEFAULT_VERIFY_CONCURRENCY = 12\nconst REQUIRED_PROPERTIES = {\n  _id: 'string',\n  _type: 'string',\n  assetId: 'string',\n  extension: 'string',\n  mimeType: 'string',\n  path: 'string',\n  sha1hash: 'string',\n  size: 'number',\n  url: 'string',\n} as const\n\nexport async function validateAssetDocuments(\n  docs: SanityDocument[],\n  options: ImportOptions,\n): Promise<void> {\n  const {targetProjectId, targetDataset} = options\n  const concurrency = options.assetVerificationConcurrency || DEFAULT_VERIFY_CONCURRENCY\n\n  const assetDocs = docs.filter((doc) =>\n    /^sanity\\.[a-zA-Z]+Asset$/.test(doc._type || ''),\n  ) as AssetDocument[]\n  if (assetDocs.length === 0) {\n    return\n  }\n\n  options.onProgress({step: 'Validating asset documents'})\n\n  assetDocs.forEach((doc) => validateAssetDocumentProperties(doc))\n\n  // Don't allow assets that reference different datasets (unless explicitly allowing it)\n  if (!options.allowAssetsInDifferentDataset) {\n    assetDocs.forEach((doc) => {\n      const id = doc._id || doc.url\n      const {projectId, dataset} = getLocationFromDocument(doc)\n      const resolveText = `See ${generateHelpUrl('import-asset-has-different-target')}`\n\n      if (projectId !== targetProjectId) {\n        throw new Error(\n          `Asset ${id} references a different project ID than the specified target (asset is in ${projectId}, importing to ${targetProjectId}). ${resolveText}`,\n        )\n      }\n\n      if (dataset !== targetDataset) {\n        throw new Error(\n          `Asset ${id} references a different dataset than the specified target (asset is in ${dataset}, importing to ${targetDataset}). ${resolveText}`,\n        )\n      }\n    })\n  }\n\n  if (!options.allowFailingAssets) {\n    await pMap(assetDocs, ensureAssetUrlExists, {concurrency})\n  }\n}\n\nfunction getLocationFromDocument(doc: AssetDocument): {projectId: string; dataset: string} {\n  const url = doc.path || doc.url || ''\n  const path = url.replace(/^https:\\/\\/cdn\\.sanity\\.[a-z]+\\//, '')\n  const [, projectId, dataset] = path.split('/')\n  return {projectId: projectId || '', dataset: dataset || ''}\n}\n\nasync function ensureAssetUrlExists(assetDoc: AssetDocument): Promise<boolean> {\n  const url = assetDoc.url!\n  const start = Date.now()\n  const exists = await urlExists(url)\n  logger(`${url}: %s (%d ms)`, exists ? 'exists' : 'does not exist', Date.now() - start)\n\n  if (!exists) {\n    const helpUrl = generateHelpUrl('import-asset-file-does-not-exist')\n    throw new Error(\n      `Document ${assetDoc._id} points to a URL that does not exist (${url}). See ${helpUrl}.`,\n    )\n  }\n\n  return true\n}\n\nfunction validateAssetDocumentProperties(assetDoc: AssetDocument): void {\n  Object.keys(REQUIRED_PROPERTIES).forEach((prop) => {\n    const expectedType = REQUIRED_PROPERTIES[prop as keyof typeof REQUIRED_PROPERTIES]\n    const propValue = (assetDoc as Record<string, unknown>)[prop]\n    if (typeof propValue !== expectedType) {\n      const errorType = typeof propValue === 'undefined' ? 'is missing' : 'has invalid type for'\n\n      throw new Error(`Asset document ${assetDoc._id} ${errorType} required property \"${prop}\"`)\n    }\n  })\n\n  if (assetDoc._type === 'sanity.imageAsset') {\n    validateImageMetadata(assetDoc)\n  }\n}\n\nfunction validateImageMetadata(assetDoc: AssetDocument): void {\n  if (!assetDoc.metadata) {\n    throw new Error(`Asset document ${assetDoc._id} is missing required property \"metadata\"`)\n  }\n\n  if (!assetDoc.metadata.dimensions) {\n    throw new Error(\n      `Asset document ${assetDoc._id} is missing required property \"metadata.dimensions\"`,\n    )\n  }\n\n  const dimensionProps = ['width', 'height', 'aspectRatio']\n  const metadata = assetDoc.metadata as AssetMetadata\n  dimensionProps.forEach((prop) => {\n    if (typeof metadata.dimensions?.[prop as keyof typeof metadata.dimensions] !== 'number') {\n      throw new Error(\n        `Asset document ${assetDoc._id} is missing required property \"metadata.dimensions.${prop}\"`,\n      )\n    }\n  })\n}\n"],"names":["generateHelpUrl","debug","pMap","urlExists","logger","DEFAULT_VERIFY_CONCURRENCY","REQUIRED_PROPERTIES","_id","_type","assetId","extension","mimeType","path","sha1hash","size","url","validateAssetDocuments","docs","options","targetProjectId","targetDataset","concurrency","assetVerificationConcurrency","assetDocs","filter","doc","test","length","onProgress","step","forEach","validateAssetDocumentProperties","allowAssetsInDifferentDataset","id","projectId","dataset","getLocationFromDocument","resolveText","Error","allowFailingAssets","ensureAssetUrlExists","replace","split","assetDoc","start","Date","now","exists","helpUrl","Object","keys","prop","expectedType","propValue","errorType","validateImageMetadata","metadata","dimensions","dimensionProps"],"mappings":"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"}