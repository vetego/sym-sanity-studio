{"version":3,"file":"getGraphQLAPIs.js","sources":["../../src/_internal/cli/actions/graphql/getGraphQLAPIs.ts"],"sourcesContent":["import path from 'node:path'\nimport {fileURLToPath} from 'node:url'\nimport {isMainThread, Worker} from 'node:worker_threads'\n\nimport {type CliCommandContext} from '@sanity/cli'\nimport readPkgUp from 'read-pkg-up'\nimport {createSchema} from 'sanity'\n\nimport {\n  type ResolvedGraphQLAPI,\n  type ResolvedSourceProperties,\n  type SchemaDefinitionish,\n  type TypeResolvedGraphQLAPI,\n} from './types'\n\nconst __dirname = path.dirname(fileURLToPath(import.meta.url))\n\nexport async function getGraphQLAPIs(cliContext: CliCommandContext): Promise<ResolvedGraphQLAPI[]> {\n  if (!isMainThread) {\n    throw new Error('getGraphQLAPIs() must be called from the main thread')\n  }\n\n  const defaultSchema = createSchema({name: 'default', types: []})\n  const defaultTypes = defaultSchema.getTypeNames()\n  const isCustomType = (type: SchemaDefinitionish) => !defaultTypes.includes(type.name)\n\n  const apis = await getApisWithSchemaTypes(cliContext)\n  const resolved = apis.map(\n    ({schemaTypes, ...api}): ResolvedSourceProperties => ({\n      schema: createSchema({name: 'default', types: schemaTypes.filter(isCustomType)}),\n      ...api,\n    }),\n  )\n\n  return resolved\n}\n\nfunction getApisWithSchemaTypes(cliContext: CliCommandContext): Promise<TypeResolvedGraphQLAPI[]> {\n  return new Promise<TypeResolvedGraphQLAPI[]>((resolve, reject) => {\n    const {cliConfig, cliConfigPath, workDir} = cliContext\n    const rootPkgPath = readPkgUp.sync({cwd: __dirname})?.path\n    if (!rootPkgPath) {\n      throw new Error('Could not find root directory for `sanity` package')\n    }\n\n    const rootDir = path.dirname(rootPkgPath)\n    const workerPath = path.join(\n      rootDir,\n      'lib',\n      '_internal',\n      'cli',\n      'threads',\n      'getGraphQLAPIs.cjs',\n    )\n    const worker = new Worker(workerPath, {\n      workerData: {cliConfig: serialize(cliConfig || {}), cliConfigPath, workDir},\n      env: process.env,\n    })\n    worker.on('message', resolve)\n    worker.on('error', reject)\n    worker.on('exit', (code) => {\n      if (code !== 0) reject(new Error(`Worker stopped with exit code ${code}`))\n    })\n  })\n}\n\nfunction serialize<T>(obj: T): T {\n  try {\n    return JSON.parse(JSON.stringify(obj))\n  } catch (cause) {\n    throw new Error(`Failed to serialize CLI configuration`, {cause})\n  }\n}\n"],"names":["__dirname","path","dirname","fileURLToPath","import","url","getGraphQLAPIs","cliContext","isMainThread","Error","defaultTypes","createSchema","name","types","getTypeNames","isCustomType","type","includes","getApisWithSchemaTypes","map","schemaTypes","api","schema","filter","Promise","resolve","reject","cliConfig","cliConfigPath","workDir","rootPkgPath","readPkgUp","sync","cwd","rootDir","workerPath","join","worker","Worker","workerData","serialize","env","process","on","code","obj","JSON","parse","stringify","cause"],"mappings":";;;;;AAeA,MAAMA,cAAYC,KAAKC,QAAQC,cAAcC,YAAYC,GAAG,CAAC;AAE7D,eAAsBC,eAAeC,YAA8D;AACjG,MAAI,CAACC;AACH,UAAM,IAAIC,MAAM,sDAAsD;AAIxE,QAAMC,eADgBC,aAAa;AAAA,IAACC,MAAM;AAAA,IAAWC,OAAO,CAAA;AAAA,EAAA,CAAG,EAC5BC,gBAC7BC,eAAgBC,UAA8B,CAACN,aAAaO,SAASD,KAAKJ,IAAI;AAUpF,UARa,MAAMM,uBAAuBX,UAAU,GAC9BY,IACpB,CAAC;AAAA,IAACC;AAAAA,IAAa,GAAGC;AAAAA,EAAAA,OAAoC;AAAA,IACpDC,QAAQX,aAAa;AAAA,MAACC,MAAM;AAAA,MAAWC,OAAOO,YAAYG,OAAOR,YAAY;AAAA,IAAA,CAAE;AAAA,IAC/E,GAAGM;AAAAA,EAAAA,EAEP;AAGF;AAEA,SAASH,uBAAuBX,YAAkE;AAChG,SAAO,IAAIiB,QAAkC,CAACC,SAASC,WAAW;AAChE,UAAM;AAAA,MAACC;AAAAA,MAAWC;AAAAA,MAAeC;AAAAA,IAAAA,IAAWtB,YACtCuB,cAAcC,UAAUC,KAAK;AAAA,MAACC,KAAKjC;AAAAA,IAAAA,CAAU,GAAGC;AACtD,QAAI,CAAC6B;AACH,YAAM,IAAIrB,MAAM,oDAAoD;AAGtE,UAAMyB,UAAUjC,KAAKC,QAAQ4B,WAAW,GAClCK,aAAalC,KAAKmC,KACtBF,SACA,OACA,aACA,OACA,WACA,oBACF,GACMG,SAAS,IAAIC,OAAOH,YAAY;AAAA,MACpCI,YAAY;AAAA,QAACZ,WAAWa,UAAUb,aAAa,EAAE;AAAA,QAAGC;AAAAA,QAAeC;AAAAA,MAAAA;AAAAA,MACnEY,KAAKC,QAAQD;AAAAA,IAAAA,CACd;AACDJ,WAAOM,GAAG,WAAWlB,OAAO,GAC5BY,OAAOM,GAAG,SAASjB,MAAM,GACzBW,OAAOM,GAAG,QAASC,CAAAA,SAAS;AACtBA,eAAS,KAAGlB,OAAO,IAAIjB,MAAM,iCAAiCmC,IAAI,EAAE,CAAC;AAAA,IAC3E,CAAC;AAAA,EACH,CAAC;AACH;AAEA,SAASJ,UAAaK,KAAW;AAC/B,MAAI;AACF,WAAOC,KAAKC,MAAMD,KAAKE,UAAUH,GAAG,CAAC;AAAA,EACvC,SAASI,OAAO;AACd,UAAM,IAAIxC,MAAM,yCAAyC;AAAA,MAACwC;AAAAA,IAAAA,CAAM;AAAA,EAClE;AACF;"}