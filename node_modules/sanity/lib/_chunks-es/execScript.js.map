{"version":3,"file":"execScript.js","sources":["../../src/_internal/cli/actions/exec/execScript.ts"],"sourcesContent":["import {spawn} from 'node:child_process'\nimport fs from 'node:fs/promises'\nimport path from 'node:path'\nimport {fileURLToPath} from 'node:url'\n\nimport {type CliCommandAction, type CliCommandArguments} from '@sanity/cli'\nimport readPkgUp from 'read-pkg-up'\nimport {hideBin} from 'yargs/helpers'\nimport yargs from 'yargs/yargs'\n\nconst __dirname = path.dirname(fileURLToPath(import.meta.url))\n\ninterface ExecFlags {\n  'with-user-token'?: boolean\n  'mock-browser-env'?: boolean\n}\n\nasync function parseCliFlags(args: CliCommandArguments<ExecFlags>) {\n  const flags = await yargs(hideBin(args.argv || process.argv).slice(2))\n    .option('with-user-token', {type: 'boolean', default: false})\n    .option('mock-browser-env', {type: 'boolean', default: false}).argv\n\n  return {\n    ...flags,\n    script: args.argsWithoutOptions[0],\n  }\n}\n\nconst execScript: CliCommandAction<ExecFlags> = async function execScript(args, context) {\n  // Reparsing CLI flags for better control of binary flags\n  const {withUserToken, mockBrowserEnv, script} = await parseCliFlags(args)\n  const {workDir} = context\n\n  const scriptPath = path.resolve(script || '')\n  if (!script) {\n    throw new Error('SCRIPT must be provided. `sanity exec <script>`')\n  }\n\n  if (!(await fs.stat(scriptPath).catch(() => false))) {\n    throw new Error(`${scriptPath} does not exist`)\n  }\n\n  const sanityPkgPath = (await readPkgUp({cwd: __dirname}))?.path\n  if (!sanityPkgPath) {\n    throw new Error('Unable to resolve `sanity` module root')\n  }\n\n  const sanityDir = path.dirname(sanityPkgPath)\n  const threadsDir = path.join(sanityDir, 'lib', '_internal', 'cli', 'threads')\n  const esbuildPath = path.join(threadsDir, 'esbuild.cjs')\n  const browserEnvPath = path.join(threadsDir, 'registerBrowserEnv.cjs')\n  const configClientPath = path.join(threadsDir, 'configClient.cjs')\n\n  if (!(await fs.stat(esbuildPath).catch(() => false))) {\n    throw new Error('`sanity` module build error: missing threads')\n  }\n\n  const baseArgs = mockBrowserEnv ? ['-r', browserEnvPath] : ['-r', esbuildPath]\n  const tokenArgs = withUserToken ? ['-r', configClientPath] : []\n\n  const nodeArgs = [...baseArgs, ...tokenArgs, scriptPath, ...args.extraArguments]\n\n  const proc = spawn(process.argv[0], nodeArgs, {\n    stdio: 'inherit',\n    env: {\n      ...process.env,\n      SANITY_BASE_PATH: workDir,\n    },\n  })\n  proc.on('close', process.exit)\n}\n\nexport default execScript\n"],"names":["__dirname","path","dirname","fileURLToPath","import","url","parseCliFlags","args","yargs","hideBin","argv","process","slice","option","type","default","script","argsWithoutOptions","execScript","context","withUserToken","mockBrowserEnv","workDir","scriptPath","resolve","Error","fs","stat","catch","sanityPkgPath","readPkgUp","cwd","sanityDir","threadsDir","join","esbuildPath","browserEnvPath","configClientPath","baseArgs","tokenArgs","nodeArgs","extraArguments","spawn","stdio","env","SANITY_BASE_PATH","on","exit"],"mappings":";;;;;;;AAUA,MAAMA,cAAYC,KAAKC,QAAQC,cAAcC,YAAYC,GAAG,CAAC;AAO7D,eAAeC,cAAcC,MAAsC;AAKjE,SAAO;AAAA,IACL,GALY,MAAMC,MAAMC,QAAQF,KAAKG,QAAQC,QAAQD,IAAI,EAAEE,MAAM,CAAC,CAAC,EAClEC,OAAO,mBAAmB;AAAA,MAACC,MAAM;AAAA,MAAWC,SAAS;AAAA,IAAA,CAAM,EAC3DF,OAAO,oBAAoB;AAAA,MAACC,MAAM;AAAA,MAAWC,SAAS;AAAA,IAAA,CAAM,EAAEL;AAAAA,IAI/DM,QAAQT,KAAKU,mBAAmB,CAAC;AAAA,EAAA;AAErC;AAEA,MAAMC,aAA0C,eAA0BX,MAAMY,SAAS;AAEvF,QAAM;AAAA,IAACC;AAAAA,IAAeC;AAAAA,IAAgBL;AAAAA,EAAAA,IAAU,MAAMV,cAAcC,IAAI,GAClE;AAAA,IAACe;AAAAA,EAAAA,IAAWH,SAEZI,aAAatB,KAAKuB,QAAQR,UAAU,EAAE;AAC5C,MAAI,CAACA;AACH,UAAM,IAAIS,MAAM,iDAAiD;AAGnE,MAAI,CAAE,MAAMC,GAAGC,KAAKJ,UAAU,EAAEK,MAAM,MAAM,EAAK;AAC/C,UAAM,IAAIH,MAAM,GAAGF,UAAU,iBAAiB;AAGhD,QAAMM,iBAAiB,MAAMC,UAAU;AAAA,IAACC,KAAK/B;AAAAA,EAAAA,CAAU,IAAIC;AAC3D,MAAI,CAAC4B;AACH,UAAM,IAAIJ,MAAM,wCAAwC;AAG1D,QAAMO,YAAY/B,KAAKC,QAAQ2B,aAAa,GACtCI,aAAahC,KAAKiC,KAAKF,WAAW,OAAO,aAAa,OAAO,SAAS,GACtEG,cAAclC,KAAKiC,KAAKD,YAAY,aAAa,GACjDG,iBAAiBnC,KAAKiC,KAAKD,YAAY,wBAAwB,GAC/DI,mBAAmBpC,KAAKiC,KAAKD,YAAY,kBAAkB;AAEjE,MAAI,CAAE,MAAMP,GAAGC,KAAKQ,WAAW,EAAEP,MAAM,MAAM,EAAK;AAChD,UAAM,IAAIH,MAAM,8CAA8C;AAGhE,QAAMa,WAAWjB,iBAAiB,CAAC,MAAMe,cAAc,IAAI,CAAC,MAAMD,WAAW,GACvEI,YAAYnB,gBAAgB,CAAC,MAAMiB,gBAAgB,IAAI,CAAA,GAEvDG,WAAW,CAAC,GAAGF,UAAU,GAAGC,WAAWhB,YAAY,GAAGhB,KAAKkC,cAAc;AAElEC,QAAM/B,QAAQD,KAAK,CAAC,GAAG8B,UAAU;AAAA,IAC5CG,OAAO;AAAA,IACPC,KAAK;AAAA,MACH,GAAGjC,QAAQiC;AAAAA,MACXC,kBAAkBvB;AAAAA,IAAAA;AAAAA,EACpB,CACD,EACIwB,GAAG,SAASnC,QAAQoC,IAAI;AAC/B;"}