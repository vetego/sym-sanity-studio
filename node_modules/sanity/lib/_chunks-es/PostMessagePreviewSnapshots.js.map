{"version":3,"file":"PostMessagePreviewSnapshots.js","sources":["../../src/presentation/editor/PostMessagePreviewSnapshots.tsx"],"sourcesContent":["import {type ClientPerspective} from '@sanity/client'\nimport {type PreviewSnapshot} from '@sanity/presentation-comlink'\nimport {type FC, memo, useEffect, useMemo, useRef} from 'react'\nimport {\n  combineLatest,\n  debounceTime,\n  filter,\n  map,\n  merge,\n  NEVER,\n  share,\n  skipWhile,\n  Subject,\n  switchMap,\n  takeUntil,\n} from 'rxjs'\nimport {\n  getDraftId,\n  getPublishedId,\n  type PreviewValue,\n  useDocumentPreviewStore,\n  useSchema,\n} from 'sanity'\n\nimport {type VisualEditingConnection} from '../types'\n\ntype Ref = {\n  _id: string\n  _type: string\n}\n\nexport interface PostMessagePreviewsProps {\n  comlink: VisualEditingConnection\n  perspective: ClientPerspective\n  refs: Ref[]\n}\n\nconst PostMessagePreviews: FC<PostMessagePreviewsProps> = (props) => {\n  const {comlink, refs, perspective} = props\n  const documentPreviewStore = useDocumentPreviewStore()\n  const schema = useSchema()\n\n  const refsSubject = useMemo(() => new Subject<Ref[]>(), [])\n\n  const previews$ = useMemo(() => {\n    return refsSubject.asObservable().pipe(\n      switchMap(\n        (\n          // eslint-disable-next-line @typescript-eslint/no-shadow\n          refs,\n        ) => {\n          return combineLatest(\n            refs.map((ref) => {\n              const draftRef = {...ref, _id: getDraftId(ref._id)}\n              const draft$ =\n                perspective === 'published'\n                  ? // Don't emit if not displaying drafts\n                    NEVER\n                  : documentPreviewStore\n                      .observeForPreview(draftRef, schema.get(draftRef._type)!)\n                      .pipe(\n                        // Share to prevent double subscribe in the merge\n                        share(),\n                        // Don't emit if no snapshot is returned\n                        // eslint-disable-next-line max-nested-callbacks\n                        skipWhile((p) => p.snapshot === null),\n                      )\n\n              const publishedRef = {...ref, _id: getPublishedId(ref._id)}\n              const published$ = documentPreviewStore.observeForPreview(\n                publishedRef,\n                schema.get(publishedRef._type)!,\n              )\n\n              return merge(published$.pipe(takeUntil(draft$)), draft$).pipe(\n                // eslint-disable-next-line max-nested-callbacks\n                filter((p) => !!p.snapshot),\n                // eslint-disable-next-line max-nested-callbacks\n                map((p) => {\n                  const snapshot = p.snapshot as PreviewValue & {\n                    _id: string\n                  }\n                  return {\n                    _id: getPublishedId(snapshot._id),\n                    title: snapshot.title,\n                    subtitle: snapshot.subtitle,\n                    description: snapshot.description,\n                    imageUrl: snapshot.imageUrl,\n                  } as PreviewSnapshot\n                }),\n              )\n            }),\n          )\n        },\n      ),\n      debounceTime(0),\n    )\n  }, [documentPreviewStore, refsSubject, schema, perspective])\n\n  const lastSnapshots = useRef<PreviewSnapshot[]>([])\n\n  // Stream preview snapshots when updates are received, and store the last set\n  // of snapshots so they can be returned if explicitly requested\n  useEffect(() => {\n    const sub = previews$.subscribe((snapshots) => {\n      comlink.post('presentation/preview-snapshots', {snapshots})\n      lastSnapshots.current = snapshots\n    })\n\n    return () => {\n      sub.unsubscribe()\n    }\n  }, [comlink, previews$])\n\n  // Respond to explict requests for preview snapshots. Streaming will not\n  // always suffice as the previews$ subscriber will not be called if the app\n  // reloads but Presentation does not.\n  useEffect(() => {\n    return comlink.on('visual-editing/preview-snapshots', () => ({\n      snapshots: lastSnapshots.current,\n    }))\n  }, [comlink])\n\n  useEffect(() => {\n    refsSubject.next(refs)\n  }, [refs, refsSubject])\n\n  return null\n}\n\nexport default memo(PostMessagePreviews)\n"],"names":["PostMessagePreviews","props","$","_c","comlink","refs","perspective","documentPreviewStore","useDocumentPreviewStore","schema","useSchema","t0","Symbol","for","Subject","refsSubject","t1","asObservable","pipe","switchMap","refs_0","combineLatest","map","ref","draftRef","_id","getDraftId","draft$","NEVER","observeForPreview","get","_type","share","skipWhile","_temp","publishedRef","getPublishedId","published$","merge","takeUntil","filter","_temp2","_temp3","debounceTime","previews$","t2","lastSnapshots","useRef","t3","t4","sub","subscribe","snapshots","post","current","unsubscribe","useEffect","t5","t6","on","t7","t8","next","memo","p","snapshot","p_0","p_1","title","subtitle","description","imageUrl"],"mappings":"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"}